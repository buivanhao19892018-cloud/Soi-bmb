<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (V2 ‚Ä¢ 2-ZONE OCR ‚Ä¢ PHA SAFE HardLock)</title>

  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png" type="image/png">
  <meta name="apple-mobile-web-app-capable" content="yes">

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#0b1220; --card:rgba(255,255,255,.06); --text:#e8eefc; --muted:rgba(232,238,252,.7);
      --ok:#2fe39b; --warn:#f7c948; --bad:#ff4d6d; --btn:#2d6cdf; --line:rgba(255,255,255,.08);
      --radius:18px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0; font-family:var(--sans); color:var(--text);
      background:radial-gradient(1200px 900px at 20% 10%, #152348, transparent 60%),
                 radial-gradient(900px 700px at 80% 30%, #153a2d, transparent 55%),
                 var(--bg);}
    .wrap{max-width:1060px; margin:0 auto; padding:18px 14px 28px;}
    .title{font-size:22px; font-weight:900; margin:6px 0;}
    .sub{color:var(--muted); font-size:13px; line-height:1.4; margin:0 0 14px;}
    .card{background:linear-gradient(180deg, var(--card), rgba(255,255,255,.03)); border:1px solid var(--line);
      border-radius:var(--radius); padding:14px;}
    .row{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
    .pill{display:inline-flex; align-items:center; gap:8px; padding:9px 12px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid var(--line); font-size:12px; color:var(--muted);}
    .dot{width:9px; height:9px; border-radius:999px; background:var(--warn);}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    .btn{appearance:none; border:0; border-radius:14px; padding:11px 14px; font-weight:900; cursor:pointer;
      background:linear-gradient(180deg, rgba(45,108,223,.95), rgba(45,108,223,.75)); color:white;
      box-shadow:0 10px 30px rgba(45,108,223,.22);}
    .btn.secondary{background:rgba(255,255,255,.07); color:var(--text); border:1px solid var(--line); box-shadow:none;}
    .btn.danger{background:linear-gradient(180deg, rgba(255,77,109,.95), rgba(255,77,109,.72));}
    .btn.small{padding:9px 12px; font-size:12px; border-radius:12px;}
    .btn:disabled{opacity:.55; cursor:not-allowed;}
    .in{width:100%; padding:12px 12px; border-radius:14px; background:rgba(0,0,0,.22); border:1px solid var(--line);
      color:var(--text); outline:none;}
    .in::placeholder{color:rgba(232,238,252,.35)}
    label{font-size:12px; color:var(--muted); display:block; margin:10px 0 6px;}
    .grid{display:grid; gap:12px;}
    @media(min-width:980px){ .grid{grid-template-columns:1.05fr .95fr;} }
    .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px;}
    .box{background:rgba(255,255,255,.04); border:1px solid var(--line); border-radius:16px; padding:12px;}
    .big{font-size:34px; font-weight:900; letter-spacing:.4px;}
    .cap{color:var(--muted); font-size:12px; margin-top:2px;}
    .hr{height:1px; background:var(--line); margin:14px 0;}
    .mono{font-family:var(--mono); font-size:12.5px; line-height:1.4; white-space:pre-wrap; word-break:break-word;}
    .boxmono{background:rgba(0,0,0,.25); border:1px solid var(--line); border-radius:16px; padding:12px;}
    .hint{color:var(--muted); font-size:12px; line-height:1.45;}
    .preview{width:100%; border-radius:16px; background:#0a0f1b; border:1px dashed rgba(255,255,255,.18); padding:10px;}
    .preview canvas{max-width:100%; height:auto; display:block; margin:0 auto; border-radius:12px;}
    .chips{display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;}
    .chip{padding:8px 10px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid var(--line);
      font-size:12px; color:var(--muted);}
    .chip b{color:var(--text)}
    .badge{display:inline-block; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.08);
      border:1px solid var(--line); font-size:11px; color:var(--muted);}
    .safeCard{padding:14px; background:linear-gradient(180deg, rgba(47,227,155,.10), rgba(255,255,255,.03));}
    input[type="range"]{width:100%}
    .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:10px;}
    @media(max-width:720px){ .twoCols{grid-template-columns:1fr;} }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER (V2 ‚Ä¢ 2-ZONE OCR ‚Ä¢ PHA SAFE HardLock)</div>
    <p class="sub">
      Lu·ªìng cao nh·∫•t: <b>StartDate Hard-Assign</b> ‚Üí Preprocess ‚Üí <b>OCR 2-ZONE</b> (DB ri√™ng / BOTTOM ri√™ng) ‚Üí
      Gate DB/G7/G6 ‚Üí HardLock chu·ªói ng√†y ‚Üí m·ªü PHA SAFE. Thi·∫øu/kh√¥ng ch·∫Øc ‚Üí <b>STOP</b>.
    </p>

    <div class="card">
      <div class="row" style="justify-content:space-between; gap:12px">
        <div class="row">
          <span class="pill"><span id="stPre" class="dot"></span> Preprocess</span>
          <span class="pill"><span id="stOcr" class="dot"></span> OCR (DB+BOTTOM)</span>
          <span class="pill"><span id="stGate" class="dot"></span> Gate</span>
          <span class="pill"><span id="stPha" class="dot"></span> PHA SAFE</span>
          <span class="badge" id="hardLockBadge">HardLock=ON</span>
          <span class="badge">V2=2-ZONE</span>
        </div>
        <div class="row">
          <button class="btn secondary" id="btnPaste">D√°n m·∫´u</button>
          <button class="btn danger" id="btnReset">RESET S·∫†CH</button>
        </div>
      </div>

      <div class="hr"></div>

      <div class="grid">
        <!-- Left -->
        <div>
          <div class="row" style="gap:10px">
            <input id="file" type="file" accept="image/*" multiple style="display:none" />
            <button class="btn" id="btnUpload">üì∏ Upload nhi·ªÅu ·∫£nh</button>
            <button class="btn secondary" id="btnCamera">üé• Camera</button>
            <button class="btn secondary" id="btnStopCam" disabled>‚õî T·∫Øt camera</button>
            <button class="btn" id="btnRun" style="margin-left:auto">‚ö° CH·∫†Y FULL</button>
          </div>

          <div class="kpi">
            <div class="box">
              <div class="cap">Batch</div>
              <div class="big"><span id="kOk">0</span> <span class="cap">OK</span> <span style="opacity:.35">|</span> <span id="kFail">0</span> <span class="cap">FAIL</span></div>
              <div class="cap">·∫¢nh ƒë√£ n·∫°p: <span id="kCount">0</span></div>
            </div>
            <div class="box">
              <div class="cap">Save</div>
              <div class="big"><span id="kDays">0</span> <span class="cap">ng√†y</span></div>
              <div class="cap">L∆∞u localStorage (offline OK)</div>
            </div>
          </div>

          <div class="hr"></div>

          <label>StartDate (b·∫Øt bu·ªôc ‚Äî YYYY-MM-DD)</label>
          <input class="in" id="startDate" placeholder="VD: 2026-02-28" />
          <div class="hint" style="margin-top:6px">
            C·ª©ng nh·∫•t: <b>ng√†y = StartDate + index ·∫£nh</b>. Header OCR ch·ªâ ƒë·ªÉ x√°c nh·∫≠n (kh√¥ng quy·∫øt ƒë·ªãnh).
          </div>

          <label>Manual Fix (DB|G7|G6) ‚Äî d√°n khi OCR l·ªách</label>
          <input class="in" id="manualFix" placeholder="VD: DB=83 | G7=57 42 39 13 | G6=247 554 108" />
          <div class="hint" style="margin-top:6px">Ch·ªâ d√πng khi Gate fail. Kh√¥ng ‚Äúƒëo√°n d·ªØ li·ªáu‚Äù.</div>

          <div class="hr"></div>

          <div class="row">
            <button class="btn secondary small" id="btnRescue">Rescue presets: ON</button>
            <span class="chip"><b>Gate-3</b>&nbsp;l·ªách ng√†y = STOP</span>
            <span class="chip"><b>∆Øu ti√™n</b>&nbsp;G7 theo d√≤ng ‚Äú7 ‚Ä¶‚Äù</span>
          </div>

          <div class="hr"></div>

          <div class="box">
            <div style="font-weight:900; margin-bottom:6px;">V2 ‚Ä¢ C·∫•u h√¨nh 2 v√πng OCR (an to√†n)</div>
            <div class="hint">T√°ch v√πng gi√∫p G7/G6 kh√¥ng b·ªã ‚Äúd√≠nh‚Äù s·ªë gi·ªØa b·∫£ng. N·∫øu ·∫£nh b·ªã l·ªách khung ‚Üí b·∫≠t Rescue.</div>

            <div class="twoCols" style="margin-top:10px">
              <div class="box" style="margin:0; padding:10px;">
                <div class="cap"><b>V√πng DB (OCR_DB)</b> ‚Äî l·∫•y t·ª´ ph·∫ßn tr√™n</div>
                <div class="cap">Top: <span id="dbTopV">18</span>%</div>
                <input id="dbTop" type="range" min="0" max="40" step="1" value="18">
                <div class="cap">Height: <span id="dbHV">22</span>%</div>
                <input id="dbH" type="range" min="10" max="40" step="1" value="22">
              </div>

              <div class="box" style="margin:0; padding:10px;">
                <div class="cap"><b>V√πng BOTTOM (OCR_BOTTOM)</b> ‚Äî l·∫•y cu·ªëi b·∫£ng</div>
                <div class="cap">From: <span id="botFromV">62</span>% (t·ª´ tr√™n xu·ªëng)</div>
                <input id="botFrom" type="range" min="40" max="85" step="1" value="62">
                <div class="cap">Height: <span id="botHV">36</span>%</div>
                <input id="botH" type="range" min="20" max="60" step="1" value="36">
              </div>
            </div>

            <div class="twoCols" style="margin-top:10px">
              <div class="box" style="margin:0; padding:10px;">
                <div class="cap"><b>Preprocess chung</b></div>
                <div class="cap">Trim top: <span id="trimTopV">14</span>%</div>
                <input id="trimTop" type="range" min="0" max="30" step="1" value="14">
                <div class="cap">Trim bot: <span id="trimBotV">12</span>%</div>
                <input id="trimBot" type="range" min="0" max="30" step="1" value="12">
              </div>
              <div class="box" style="margin:0; padding:10px;">
                <div class="cap"><b>Scale</b>: <span id="scaleV">2.0</span>x</div>
                <input id="scale" type="range" min="1.2" max="3.0" step="0.1" value="2.0">
                <div class="hint" style="margin-top:6px;">Khuy·∫øn ngh·ªã: 1.8‚Äì2.4x (ƒë·ªß n√©t, kh√¥ng n·∫∑ng m√°y).</div>
              </div>
            </div>
          </div>

          <div class="hint" style="margin-top:10px">
            M·∫πo ·∫£nh: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB/DB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab & header qu·∫£ng c√°o.
          </div>
        </div>

        <!-- Right -->
        <div>
          <div class="preview">
            <div class="chips">
              <span class="chip">Preview t·ªïng (auto-trim)</span>
              <span class="chip">DB-zone</span>
              <span class="chip">BOTTOM-zone</span>
            </div>
            <canvas id="can" width="600" height="800"></canvas>
          </div>

          <label>OCR Raw ‚Äî DB zone</label>
          <div class="boxmono mono" id="rawDB">‚Äî</div>

          <label>OCR Raw ‚Äî BOTTOM zone</label>
          <div class="boxmono mono" id="rawBottom">‚Äî</div>

          <label>Gate Output</label>
          <div class="boxmono mono" id="gateOut">GATE: waiting</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="card safeCard">
        <div class="row" style="justify-content:space-between">
          <div>
            <div style="font-weight:900; font-size:14px;">PHA SAFE ‚Ä¢ HardLock</div>
            <div class="hint">Ch·ªâ m·ªü pha khi ‚â• 3 ng√†y s·∫°ch. N·∫øu Gate fail / thi·∫øu tr∆∞·ªùng ‚Üí STOP.</div>
          </div>
          <span class="badge" id="phaBadge">Confidence‚âà0%</span>
        </div>

        <div class="hr"></div>

        <div class="boxmono mono" id="chainBox">(ch∆∞a c√≥ d·ªØ li·ªáu)</div>

        <div class="hr"></div>

        <div class="mono" id="phaBox">PHA: STOP
Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch).</div>

        <div class="hr"></div>

        <div class="hint">
          Checklist ch·ªëng l·ªách ng√†y / l·ªách pha:
          <ul>
            <li>Ng√†y tƒÉng ƒë√∫ng th·ª© t·ª± (Hard-Assign theo StartDate + index).</li>
            <li>M·ªói ng√†y: ph·∫£i c√≥ <b>DB2 + G7(4) + G6(3)</b>.</li>
            <li>Gate fail ‚Üí Manual Fix ho·∫∑c ch·ªânh ·∫£nh / b·∫≠t Rescue.</li>
            <li>Kh√¥ng ƒë·ªß s·∫°ch ‚Üí <b>STOP</b>.</li>
          </ul>
        </div>
      </div>

      <div class="hint" style="margin-top:10px">
        Tip PWA: Chrome Android ‚Äú‚ãÆ‚Äù ‚Üí ‚ÄúAdd to Home screen‚Äù.
      </div>
    </div>
  </div>

<script>
/* ========== PWA register ========== */
(async ()=>{
  if('serviceWorker' in navigator){
    try{ await navigator.serviceWorker.register('./sw.js'); }catch(e){}
  }
})();

/* ========== Helpers ========== */
const $ = (id)=>document.getElementById(id);
const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
function setDot(el, state){ el.classList.remove('ok','bad'); if(state==='ok') el.classList.add('ok'); else if(state==='bad') el.classList.add('bad'); }
function todayISO(d=new Date()){ const z=(n)=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function parseISODate(s){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return null;
  const [y,m,d]=s.split('-').map(Number);
  const dt=new Date(y,m-1,d);
  if(dt.getFullYear()!==y||dt.getMonth()!==m-1||dt.getDate()!==d) return null;
  return dt;
}
function addDaysISO(iso, add){
  const dt=parseISODate(iso); if(!dt) return null;
  dt.setDate(dt.getDate()+add); return todayISO(dt);
}
function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
function normalizeOCR(text){
  return (text||"")
    .replace(/\u00A0/g,' ')
    .replace(/[|]/g,' ')
    .replace(/[^\S\r\n]+/g,' ')
    .replace(/ƒêB/g,'DB')
    .replace(/\bD\s*B\b/g,'DB')
    .replace(/O/g,'0')
    .replace(/I/g,'1')
    .replace(/l/g,'1')
    .replace(/S/g,'5')
    .replace(/B/g,'8');
}

/* ========== Storage ========== */
const LS_KEY = "BH_ULTRA_OCR_GATE_PWA_V2_DAYS";
const LS_CFG = "BH_ULTRA_OCR_GATE_PWA_V2_CFG";

let cfg = {
  trimTop: 14, trimBot: 12, scale: 2.0,
  // 2-zone defaults
  dbTop: 18, dbH: 22,
  botFrom: 62, botH: 36,
  ocrLang: "eng",
  rescueLevels: [
    {trimTop:14, trimBot:12, scale:2.0},
    {trimTop:16, trimBot:12, scale:2.2},
    {trimTop:12, trimBot:14, scale:2.2},
    {trimTop:18, trimBot:10, scale:2.4}
  ]
};
function loadCfg(){ try{ const raw=localStorage.getItem(LS_CFG); if(raw) cfg={...cfg, ...JSON.parse(raw)}; }catch(e){} }
function saveCfg(){ localStorage.setItem(LS_CFG, JSON.stringify(cfg)); }
function loadDays(){ try{ const raw=localStorage.getItem(LS_KEY); const a=raw?JSON.parse(raw):[]; return Array.isArray(a)?a:[]; }catch(e){ return []; } }
function saveDays(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); $("kDays").textContent = String(arr.length); }

/* ========== Canvas preprocess (full preview) ========== */
const can = $("can");
const ctx = can.getContext("2d");
function drawBlank(){
  ctx.clearRect(0,0,can.width,can.height);
  ctx.fillStyle="rgba(255,255,255,.04)"; ctx.fillRect(0,0,can.width,can.height);
  ctx.fillStyle="rgba(232,238,252,.65)"; ctx.font="16px system-ui"; ctx.textAlign="center";
  ctx.fillText("Preview s·∫Ω hi·ªán ·ªü ƒë√¢y", can.width/2, can.height/2);
}
function blobToImage(blob){
  return new Promise((res,rej)=>{
    const url=URL.createObjectURL(blob);
    const img=new Image();
    img.onload=()=>{ URL.revokeObjectURL(url); res(img); };
    img.onerror=(e)=>{ URL.revokeObjectURL(url); rej(e); };
    img.src=url;
  });
}
async function drawPreprocessFromBlob(blob){
  const img = await blobToImage(blob);
  const w = img.naturalWidth, h = img.naturalHeight;
  const top = Math.floor(h * (cfg.trimTop/100));
  const bot = Math.floor(h * (cfg.trimBot/100));
  const cropH = clamp(h - top - bot, 50, h);
  const outW = Math.floor(w * cfg.scale);
  const outH = Math.floor(cropH * cfg.scale);

  can.width = clamp(outW, 360, 1500);
  can.height = clamp(outH, 360, 1900);

  ctx.imageSmoothingEnabled=true; ctx.imageSmoothingQuality="high";
  ctx.drawImage(img, 0, top, w, cropH, 0, 0, can.width, can.height);

  // grayscale + contrast
  const imgData = ctx.getImageData(0,0,can.width,can.height);
  const d = imgData.data;
  const contrast = 1.25, intercept = 128*(1-contrast);
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let y = (0.299*r+0.587*g+0.114*b);
    y = y*contrast + intercept; y = clamp(y,0,255);
    d[i]=d[i+1]=d[i+2]=y;
  }
  ctx.putImageData(imgData,0,0);

  drawZoneOverlay();
  syncUI();
}
function drawZoneOverlay(){
  const W=can.width, H=can.height;
  const dbY = Math.floor(H * (cfg.dbTop/100));
  const dbH = Math.floor(H * (cfg.dbH/100));
  const botY = Math.floor(H * (cfg.botFrom/100));
  const botH = Math.floor(H * (cfg.botH/100));

  ctx.save();
  ctx.lineWidth = 4;

  ctx.strokeStyle = "rgba(47,227,155,.85)";
  ctx.fillStyle   = "rgba(47,227,155,.10)";
  ctx.fillRect(8, dbY, W-16, dbH);
  ctx.strokeRect(8, dbY, W-16, dbH);
  ctx.fillStyle="rgba(47,227,155,.95)";
  ctx.font="bold 18px system-ui";
  ctx.fillText("DB zone", 18, dbY+26);

  ctx.strokeStyle = "rgba(247,201,72,.90)";
  ctx.fillStyle   = "rgba(247,201,72,.10)";
  ctx.fillRect(8, botY, W-16, botH);
  ctx.strokeRect(8, botY, W-16, botH);
  ctx.fillStyle="rgba(247,201,72,.95)";
  ctx.fillText("BOTTOM zone (G6/G7)", 18, botY+26);

  ctx.restore();
}
function cropCanvasToBlob(y, h, type="image/png", quality=0.92){
  return new Promise((res)=>{
    const tmp=document.createElement("canvas");
    tmp.width=can.width;
    tmp.height=h;
    const tctx=tmp.getContext("2d");
    tctx.drawImage(can, 0, y, can.width, h, 0, 0, tmp.width, tmp.height);

    const imgData=tctx.getImageData(0,0,tmp.width,tmp.height);
    const d=imgData.data;
    const contrast=1.35, intercept=128*(1-contrast);
    for(let i=0;i<d.length;i+=4){
      let yv=d[i];
      yv=yv*contrast+intercept; yv=clamp(yv,0,255);
      d[i]=d[i+1]=d[i+2]=yv;
    }
    tctx.putImageData(imgData,0,0);

    tmp.toBlob(res, type, quality);
  });
}

/* ========== OCR ========== */
async function ocrBlob(blob){
  const { data } = await Tesseract.recognize(blob, cfg.ocrLang, { logger: ()=>{} });
  const raw = (data && data.text) ? data.text : "";
  const norm = normalizeOCR(raw);
  return { raw, norm };
}

/* ========== Gate extraction (V2) ========== */
function extractDB2_fromDBZone(t){
  let m = t.match(/\bDB\b[\s:]*([0-9]{5})/i);
  if(m) return m[1].slice(-2);
  const m2 = t.match(/\b(\d{5})\b/);
  if(m2) return m2[1].slice(-2);
  return null;
}
function extractG7_fromBottom(t){
  let m = t.match(/(^|\n)\s*7\s+(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})(?=\s|$)/);
  if(m) return [m[2],m[3],m[4],m[5]];
  m = t.match(/(^|\n)\s*7\s*[:\-]\s*(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})(?=\s|$)/);
  if(m) return [m[2],m[3],m[4],m[5]];
  const lines = t.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  let cand=null;
  for(const line of lines){
    const nums=line.match(/\b\d{2}\b/g);
    if(nums && nums.length===4) cand=nums;
  }
  return cand;
}
function extractG6_fromBottom(t){
  let m = t.match(/(^|\n)\s*6\s+(\d{3})\s+(\d{3})\s+(\d{3})(?=\s|$)/);
  if(m) return [m[2],m[3],m[4]];
  const triples=[...t.matchAll(/(^|\n)\s*(\d{3})\s+(\d{3})\s+(\d{3})(?=\s|$)/g)];
  if(triples.length){
    const last=triples[triples.length-1];
    return [last[2],last[3],last[4]];
  }
  return null;
}
function applyManualFix(manual){
  const out = {};
  const s = manual || "";
  const mDB = s.match(/DB\s*=\s*(\d{2})/i); if(mDB) out.db2=mDB[1];
  const mG7 = s.match(/G7\s*=\s*(\d{2})\s+(\d{2})\s+(\d{2})\s+(\d{2})/i); if(mG7) out.g7=[mG7[1],mG7[2],mG7[3],mG7[4]];
  const mG6 = s.match(/G6\s*=\s*(\d{3})\s+(\d{3})\s+(\d{3})/i); if(mG6) out.g6=[mG6[1],mG6[2],mG6[3]];
  return out;
}
function gateV2(textDB, textBottom, manualFixStr){
  const errs=[];
  let db2=extractDB2_fromDBZone(textDB);
  let g7=extractG7_fromBottom(textBottom);
  let g6=extractG6_fromBottom(textBottom);

  const mf=applyManualFix(manualFixStr);
  if(!db2 && mf.db2) db2=mf.db2;
  if(!g7 && mf.g7) g7=mf.g7;
  if(!g6 && mf.g6) g6=mf.g6;

  if(!db2 || !/^\d{2}$/.test(db2)) errs.push("MISS_DB2");
  if(!g7 || g7.length!==4 || g7.some(x=>!/^\d{2}$/.test(x))) errs.push("MISS_G7");
  if(!g6 || g6.length!==3 || g6.some(x=>!/^\d{3}$/.test(x))) errs.push("MISS_G6");

  return { ok: errs.length===0, errs, db2, g7, g6 };
}

/* ========== HardLock + PHA SAFE ========== */
function hardLockChain(startDateISO, dayItems){
  const errs=[];
  if(!parseISODate(startDateISO)) errs.push("MISS_STARTDATE");
  if(dayItems.length===0) errs.push("EMPTY_BATCH");
  if(errs.length) return {ok:false, errs};

  const chain = dayItems.map((x,i)=>({ date:addDaysISO(startDateISO,i), ...x }));
  if(chain.some(x=>!x.date)) return {ok:false, errs:["BAD_DATE_ASSIGN"]};

  const miss = chain.filter(x=>!(x.db2 && x.g7 && x.g6));
  if(miss.length) return {ok:false, errs:["INCOMPLETE_DAY_FIELDS"]};
  return {ok:true, errs:[], chain};
}
function phaSafe(chain){
  if(!chain || chain.length < 3){
    return { pha:"STOP", conf:25, note:"Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch)." };
  }
  const last = chain.slice(-3).map(x=>x.db2);
  const uniq = new Set(last).size;
  let conf = 58;
  let note = "Chu·ªói s·∫°ch. V2=2-zone gi·∫£m nhi·ªÖu. (Module pha chi ti·∫øt g·∫Øn sau)";
  if(uniq===1){ conf=64; note="Chu·ªói s·∫°ch. ƒêB ƒëang neo (ƒëu√¥i l·∫∑p 3/3)."; }
  else if(uniq===2){ conf=60; note="Chu·ªói s·∫°ch. Neo nh·∫π (ƒëu√¥i l·∫∑p 2/3)."; }
  return { pha:"OK", conf, note };
}

/* ========== Camera ========== */
let camStream=null;
async function startCamera(){
  if(camStream) return;
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
    $("btnStopCam").disabled=false;
    const ok = confirm("Camera ƒë√£ b·∫≠t. Nh·∫•n OK ƒë·ªÉ ch·ª•p 1 ·∫£nh ƒë∆∞a v√†o batch.");
    if(!ok){ stopCamera(); return; }
    const v=document.createElement("video");
    v.autoplay=true; v.playsInline=true; v.muted=true; v.srcObject=camStream;
    await sleep(800);
    can.width=900; can.height=1200;
    ctx.drawImage(v,0,0,can.width,can.height);
    const blob = await new Promise(res=>can.toBlob(res,"image/jpeg",0.92));
    addBlobToBatch(blob, "camera.jpg");
    stopCamera();
  }catch(e){
    alert("Kh√¥ng b·∫≠t ƒë∆∞·ª£c camera: "+e.message);
    stopCamera();
  }
}
function stopCamera(){
  if(camStream){ camStream.getTracks().forEach(t=>t.stop()); camStream=null; }
  $("btnStopCam").disabled=true;
}

/* ========== Batch + UI ========== */
let images=[];
let running=false;

function setStatusAll(pre, ocr, gate, pha){
  setDot($("stPre"), pre); setDot($("stOcr"), ocr); setDot($("stGate"), gate); setDot($("stPha"), pha);
}
function addBlobToBatch(blob, name="img.jpg"){
  const url=URL.createObjectURL(blob);
  images.push({name, blob, url});
  $("kCount").textContent=String(images.length);
  drawPreprocessFromBlob(blob).catch(()=>{});
}
function resetAll(){
  images.forEach(x=>URL.revokeObjectURL(x.url));
  images=[];
  $("kCount").textContent="0"; $("kOk").textContent="0"; $("kFail").textContent="0";
  $("rawDB").textContent="‚Äî"; $("rawBottom").textContent="‚Äî";
  $("gateOut").textContent="GATE: waiting";
  $("phaBadge").textContent="Confidence‚âà0%";
  $("chainBox").textContent="(ch∆∞a c√≥ d·ªØ li·ªáu)";
  $("phaBox").textContent="PHA: STOP\nThi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch).";
  saveDays([]);
  drawBlank();
  setStatusAll("warn","warn","warn","warn");
}
function fillDemo(){
  const start = $("startDate").value.trim() || todayISO();
  const demo=[
    {date:start, db2:"81", g7:["09","81","26","36"], g6:["586","074","775"]},
    {date:addDaysISO(start,1), db2:"13", g7:["96","09","26","36"], g6:["243","887","936"]},
    {date:addDaysISO(start,2), db2:"12", g7:["30","88","09","33"], g6:["003","214","087"]}
  ];
  saveDays(demo);
  $("chainBox").textContent = demo.map(x=>`${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n");
  const p=phaSafe(demo);
  $("phaBadge").textContent=`Confidence‚âà${p.conf}%`;
  $("phaBox").textContent=`PHA: ${p.pha}\n${p.note}`;
  setStatusAll("ok","ok","ok", p.pha==="OK"?"ok":"bad");
}

/* ========== UI sync ========== */
function syncUI(){
  $("trimTopV").textContent = cfg.trimTop;
  $("trimBotV").textContent = cfg.trimBot;
  $("scaleV").textContent = cfg.scale.toFixed(1);

  $("dbTopV").textContent = cfg.dbTop;
  $("dbHV").textContent  = cfg.dbH;
  $("botFromV").textContent = cfg.botFrom;
  $("botHV").textContent   = cfg.botH;

  $("trimTop").value = cfg.trimTop;
  $("trimBot").value = cfg.trimBot;
  $("scale").value   = cfg.scale;

  $("dbTop").value = cfg.dbTop;
  $("dbH").value   = cfg.dbH;
  $("botFrom").value = cfg.botFrom;
  $("botH").value    = cfg.botH;
}

/* ========== Run FULL V2 ========== */
async function runFull(){
  if(running) return;
  running=true;

  const startDateISO=$("startDate").value.trim();
  if(!parseISODate(startDateISO)){ alert("StartDate sai format. Nh·∫≠p YYYY-MM-DD (vd: 2026-02-28)."); running=false; return; }
  if(images.length===0){ alert("Ch∆∞a c√≥ ·∫£nh. Upload nhi·ªÅu ·∫£nh ho·∫∑c d√πng Camera."); running=false; return; }

  $("btnRun").disabled=true; $("btnUpload").disabled=true; $("btnCamera").disabled=true;

  setStatusAll("warn","warn","warn","warn");
  $("gateOut").textContent="GATE: running...";
  $("rawDB").textContent="‚Äî"; $("rawBottom").textContent="‚Äî";

  let okCount=0, failCount=0;
  const dayItems=[];

  const rescueOn = $("btnRescue").dataset.on==="1";
  const levels = rescueOn ? cfg.rescueLevels : [{trimTop:cfg.trimTop, trimBot:cfg.trimBot, scale:cfg.scale}];

  for(let i=0;i<images.length;i++){
    const img=images[i];
    let gated=null;

    for(const lvl of levels){
      cfg.trimTop=lvl.trimTop; cfg.trimBot=lvl.trimBot; cfg.scale=lvl.scale;

      setDot($("stPre"),"warn");
      await drawPreprocessFromBlob(img.blob);
      setDot($("stPre"),"ok");

      const H=can.height;
      const dbY = Math.floor(H * (cfg.dbTop/100));
      const dbH = Math.floor(H * (cfg.dbH/100));
      const botY = Math.floor(H * (cfg.botFrom/100));
      const botH = Math.floor(H * (cfg.botH/100));

      const dbBlob = await cropCanvasToBlob(clamp(dbY,0,H-10), clamp(dbH,60,H));
      const botBlob= await cropCanvasToBlob(clamp(botY,0,H-10), clamp(botH,120,H));

      setDot($("stOcr"),"warn");
      const oDB = await ocrBlob(dbBlob);
      const oBT = await ocrBlob(botBlob);
      $("rawDB").textContent = oDB.norm.slice(0,900) + (oDB.norm.length>900 ? "\n...\n" : "");
      $("rawBottom").textContent = oBT.norm.slice(0,1200) + (oBT.norm.length>1200 ? "\n...\n" : "");
      setDot($("stOcr"),"ok");

      const g = gateV2(oDB.norm, oBT.norm, $("manualFix").value.trim());
      gated=g;
      if(g.ok) break;
    }

    if(gated && gated.ok){
      okCount++;
      dayItems.push({db2:gated.db2, g7:gated.g7, g6:gated.g6});
      setDot($("stGate"),"ok");
      $("gateOut").textContent =
`GATE: OK (V2 2-ZONE)
idx=${i+1}/${images.length}
DB=${gated.db2}
G7=${gated.g7.join(" ")}
G6=${gated.g6.join(" ")}
HardLock=ON`;
    }else{
      failCount++;
      dayItems.push({db2:null, g7:null, g6:null, errs:(gated?gated.errs:["UNKNOWN"])});
      setDot($("stGate"),"bad");
      $("gateOut").textContent =
`GATE: FAIL (V2 2-ZONE)
idx=${i+1}/${images.length}
errs=${(gated?gated.errs:["UNKNOWN"]).join(",")}
Try: b·∫≠t Rescue / ch·ªânh zone slider / d√πng Manual Fix.`;
    }

    $("kOk").textContent=String(okCount);
    $("kFail").textContent=String(failCount);
    await sleep(120);
  }

  const locked=hardLockChain(startDateISO, dayItems);
  if(!locked.ok){
    setStatusAll("ok","ok","bad","bad");
    $("phaBadge").textContent="Confidence‚âà0%";
    $("chainBox").textContent="(HardLock FAIL) "+locked.errs.join(",");
    $("phaBox").textContent=`PHA: STOP\nHardLock chu·ªói l·ªói: ${locked.errs.join(",")}\n=> Fix d·ªØ li·ªáu tr∆∞·ªõc, kh√¥ng soi pha.`;
    setDot($("stPha"),"bad");
  }else{
    const clean=locked.chain.filter(x=>x.db2&&x.g7&&x.g6);
    saveDays(clean);
    $("chainBox").textContent = clean.map(x=>`${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n");
    const p=phaSafe(clean);
    $("phaBadge").textContent=`Confidence‚âà${p.conf}%`;
    $("phaBox").textContent=`PHA: ${p.pha}\n${p.note}`;
    setDot($("stPha"), p.pha==="OK" ? "ok" : "bad");
    setDot($("stGate"), failCount===0 ? "ok" : "warn");
  }

  $("btnRun").disabled=false; $("btnUpload").disabled=false; $("btnCamera").disabled=false;
  running=false;
}

/* ========== Init ========== */
function init(){
  loadCfg();
  drawBlank();
  if(!$("startDate").value) $("startDate").value=todayISO();
  $("btnRescue").dataset.on="1";

  const bind = (id, key, isFloat=false)=>{
    $(id).addEventListener("input", ()=>{
      cfg[key]= isFloat ? parseFloat($(id).value) : parseInt($(id).value,10);
      saveCfg();
      try{ drawZoneOverlay(); }catch(e){}
      syncUI();
    });
  };
  bind("trimTop","trimTop");
  bind("trimBot","trimBot");
  bind("scale","scale", true);
  bind("dbTop","dbTop");
  bind("dbH","dbH");
  bind("botFrom","botFrom");
  bind("botH","botH");
  syncUI();

  const saved=loadDays();
  $("kDays").textContent=String(saved.length);
  if(saved.length){
    $("chainBox").textContent = saved.map(x=>`${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n");
    const p=phaSafe(saved);
    $("phaBadge").textContent=`Confidence‚âà${p.conf}%`;
    $("phaBox").textContent=`PHA: ${p.pha}\n${p.note}`;
    setStatusAll("ok","ok","ok", p.pha==="OK"?"ok":"bad");
  }else{
    setStatusAll("warn","warn","warn","warn");
  }

  $("btnUpload").onclick=()=>$("file").click();
  $("file").onchange=(e)=>{
    const files=[...(e.target.files||[])];
    files.forEach(f=>addBlobToBatch(f,f.name));
    e.target.value="";
  };
  $("btnCamera").onclick=startCamera;
  $("btnStopCam").onclick=stopCamera;
  $("btnRun").onclick=runFull;
  $("btnReset").onclick=()=>{ if(confirm("RESET S·∫†CH: x√≥a batch + x√≥a d·ªØ li·ªáu l∆∞u. Ch·∫Øc ch·∫Øn?")) resetAll(); };
  $("btnPaste").onclick=fillDemo;

  $("btnRescue").onclick=()=>{
    const on = $("btnRescue").dataset.on==="1";
    $("btnRescue").dataset.on = on ? "0" : "1";
    $("btnRescue").textContent = on ? "Rescue presets: OFF" : "Rescue presets: ON";
  };
}
init();
</script>
</body>
</html>
