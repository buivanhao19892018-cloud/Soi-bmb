<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî PWA SOI ƒêB (OCR Gate ‚Ä¢ Pha Safe)</title>

  <!-- Manifest as data URL (single-file friendly; SW offline cache requires extra file normally) -->
  <link rel="manifest" href='data:application/manifest+json,{"name":"B√πi H√†o ‚Äî SOI ƒêB","short_name":"SOI ƒêB","start_url":".","display":"standalone","background_color":"#070b18","theme_color":"#0b1228","icons":[{"src":"data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22512%22 height=%22512%22%3E%3Crect width=%22512%22 height=%22512%22 rx=%2296%22 fill=%22%230b1228%22/%3E%3Ctext x=%2250%25%22 y=%2252%25%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22 font-size=%2296%22 fill=%22%23ffffff%22 font-family=%22Arial%22%3EULTRA%3C/text%3E%3C/svg%3E","sizes":"512x512","type":"image/svg+xml"}]}' />

  <style>
    :root{
      --bg:#070b18;
      --card:#0b1228;
      --card2:#0f1b3a;
      --txt:#e9eefc;
      --muted:#9fb0e6;
      --line:rgba(255,255,255,.08);
      --ok:#16c784;
      --warn:#f5b800;
      --bad:#ff4d4f;
      --btn:#2f6bff;
      --btn2:#1a2a55;
      --chip:#0c1736;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(47,107,255,.25), transparent 55%),
                  radial-gradient(1000px 600px at 80% 0%, rgba(22,199,132,.16), transparent 55%),
                  var(--bg);
      color:var(--txt);
    }
    .wrap{
      max-width: 980px;
      margin: 0 auto;
      padding: 18px 14px 80px;
    }
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: 22px;
      padding: 16px 16px 14px;
      box-shadow: var(--shadow);
    }
    h1{
      margin: 6px 0 10px;
      font-size: 22px;
      line-height: 1.25;
      letter-spacing:.2px;
    }
    .sub{
      margin:0 0 14px;
      color:var(--muted);
      font-size: 13px;
      line-height: 1.45;
    }
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(12,23,54,.7);
      border:1px solid var(--line);
      color:var(--muted);
      font-size: 13px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    button{
      border:0;
      border-radius: 14px;
      padding: 12px 14px;
      font-weight: 700;
      color:white;
      background: var(--btn);
      cursor:pointer;
      box-shadow: 0 10px 26px rgba(47,107,255,.22);
    }
    button.secondary{
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      box-shadow:none;
      color: var(--txt);
    }
    button.danger{
      background: var(--bad);
      box-shadow: 0 10px 26px rgba(255,77,79,.22);
    }
    button:disabled{
      opacity:.55; cursor:not-allowed;
      box-shadow:none;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 880px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{
      margin: 0 0 10px;
      font-size: 16px;
      color: #dbe6ff;
    }
    .help{
      color:var(--muted);
      font-size: 12.5px;
      line-height: 1.45;
      margin:0 0 10px;
    }
    .preview{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .preview{grid-template-columns: repeat(2, 1fr);}
    }
    .thumb{
      border:1px solid var(--line);
      border-radius: 14px;
      overflow:hidden;
      background: rgba(0,0,0,.2);
      position:relative;
      aspect-ratio: 9/16;
    }
    .thumb img{
      width:100%; height:100%;
      object-fit: cover;
      display:block;
    }
    .thumb .badge{
      position:absolute; left:8px; top:8px;
      padding:6px 8px;
      border-radius: 999px;
      background: rgba(11,18,40,.78);
      border:1px solid var(--line);
      color: #cfe0ff;
      font-size: 12px;
      display:flex; gap:6px; align-items:center;
    }
    .thumb .badge .mini{width:8px;height:8px;border-radius:50%}
    .mini.ok{background:var(--ok)}
    .mini.warn{background:var(--warn)}
    .mini.bad{background:var(--bad)}

    .field{
      display:flex; flex-direction:column; gap:8px;
      margin-top:10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    input[type="text"], input[type="date"], textarea{
      width:100%;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      color: var(--txt);
      outline:none;
    }
    textarea{min-height: 120px; resize: vertical;}
    .split{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){
      .split{grid-template-columns:1fr}
    }
    .pillbar{display:flex; flex-wrap:wrap; gap:8px; margin-top:10px}
    .pill{
      padding: 9px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(12,23,54,.55);
      color: var(--muted);
      font-size: 12.5px;
      display:flex; gap:8px; align-items:center;
    }
    .pill strong{color:#eaf1ff}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .hr{height:1px;background:var(--line);margin:12px 0}

    .tbl{
      width:100%;
      border-collapse: collapse;
      font-size: 12.5px;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
    }
    .tbl th,.tbl td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      vertical-align: top;
    }
    .tbl th{
      text-align:left;
      color:#cfe0ff;
      background: rgba(255,255,255,.03);
    }
    .tbl tr:last-child td{border-bottom:0}
    .right{text-align:right}
    .kq{
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    .kq .line{
      display:flex; justify-content:space-between; gap:10px;
      padding:6px 0;
      border-bottom:1px dashed rgba(255,255,255,.09);
      font-size: 13px;
    }
    .kq .line:last-child{border-bottom:0}
    .tag{
      font-size: 11.5px;
      padding: 6px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(12,23,54,.55);
      color: var(--muted);
    }
    .bigmode{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.18));
      margin-top: 10px;
    }
    .bigmode .m{
      font-size: 14px;
      font-weight: 900;
      letter-spacing:.4px;
    }
    .bigmode .pct{
      font-size: 20px;
      font-weight: 900;
    }
    .note{
      color: var(--muted);
      font-size: 12.5px;
      margin-top: 8px;
      line-height: 1.45;
    }
    .footer{
      position: fixed;
      left:0; right:0; bottom:0;
      background: rgba(7,11,24,.78);
      border-top:1px solid var(--line);
      backdrop-filter: blur(12px);
      padding: 10px 12px;
    }
    .footer .wrap2{
      max-width: 980px;
      margin: 0 auto;
      display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between; align-items:center;
    }
    .footer .miniinfo{color:var(--muted);font-size:12.5px}
    a{color:#9fc2ff}
  </style>

  <!-- OCR engine (Tesseract.js). CDN (online). Manual mode always works. -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>

<body>
  <div class="wrap">
    <div class="hero">
      <h1>B√πi H√†o ‚Äî SOI ƒêB (OCR Gate ‚Ä¢ Pha Safe ‚Ä¢ HIT@3>=2)</h1>
      <p class="sub">
        Lu·ªìng: Upload nhi·ªÅu ·∫£nh / Camera ‚Üí (tu·ª≥ ch·ªçn) c·∫Øt an to√†n ‚Üí OCR ‚Üí Gate theo pattern (ƒêB/G7/G6) ‚Üí Save ‚Äú1 ng√†y/1 d√≤ng‚Äù ‚Üí CHECK PHA (HardLock) ‚Üí m·ªõi m·ªü CH·ªêT.
        <br>* Tool h·ªó tr·ª£ ph√¢n t√≠ch, kh√¥ng ƒë·∫£m b·∫£o k·∫øt qu·∫£.
      </p>

      <div class="row">
        <span class="chip"><span class="dot ok"></span> OpenCV: (lite) ‚Äî c·∫Øt an to√†n</span>
        <span class="chip"><span class="dot ok"></span> Tesseract OCR</span>
        <span class="chip"><span class="dot warn"></span> Batch nhi·ªÅu ·∫£nh</span>
        <span class="chip"><span class="dot warn"></span> DB: nh√£n ‚ÄúƒêB/DB‚Äù + 5 s·ªë</span>
        <span class="chip"><span class="dot warn"></span> G7: 4 s·ªë 2 ch·ªØ s·ªë</span>
        <span class="chip"><span class="dot warn"></span> G6: 3 s·ªë 3 ch·ªØ s·ªë</span>
        <span class="chip"><span class="dot ok"></span> Auto ‚Äú1 ng√†y / 1 d√≤ng‚Äù</span>
        <span class="chip"><span class="dot ok"></span> Fallback Manual</span>
      </div>

      <div class="btnbar">
        <button id="btnUpload">üì∏ Upload nhi·ªÅu ·∫£nh</button>
        <button class="secondary" id="btnCamera">üì∑ Camera</button>
        <button class="secondary" id="btnPasteSample">D√°n m·∫´u</button>
        <button class="danger" id="btnReset">RESET S·∫†CH</button>
      </div>

      <input id="fileInput" type="file" accept="image/*" multiple style="display:none" />
      <input id="camInput" type="file" accept="image/*" capture="environment" style="display:none" />

      <div class="pillbar" style="margin-top:12px">
        <span class="pill"><span class="dot ok"></span><strong>Gate:</strong><span id="stGate">waiting</span></span>
        <span class="pill"><span class="dot ok"></span><strong>OCR:</strong><span id="stOCR">idle</span></span>
        <span class="pill"><span class="dot warn"></span><strong>Batch:</strong><span id="stBatch">0</span></span>
        <span class="pill"><span class="dot warn"></span><strong>Save:</strong><span id="stSave">empty</span></span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: OCR Gate -->
      <div class="card">
        <h2>·∫¢nh ‚Üí OCR ‚Üí Gate</h2>
        <p class="help">
          M·∫πo: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) v√† header qu·∫£ng c√°o.
          N·∫øu ·∫£nh d√≠nh nhi·ªÅu th·ª© ‚Üí Gate d·ªÖ fail ‚Üí d√πng Manual.
        </p>

        <div class="split">
          <div>
            <label>Ch·∫ø ƒë·ªô c·∫Øt an to√†n (khuy·∫øn ngh·ªã)</label>
            <div class="row">
              <span class="chip"><span class="dot ok"></span>Auto-trim TOP/BOTTOM</span>
            </div>
            <div class="field">
              <label>Trim TOP (%)</label>
              <input id="trimTop" type="text" value="12" class="mono" />
            </div>
            <div class="field">
              <label>Trim BOTTOM (%)</label>
              <input id="trimBottom" type="text" value="12" class="mono" />
            </div>
            <button class="secondary" id="btnRebuildThumbs">√Åp trim + Rebuild preview</button>
          </div>

          <div>
            <label>Manual (d√°n text OCR / nh·∫≠p tay)</label>
            <textarea id="manualText" class="mono" placeholder="D√°n text OCR ho·∫∑c g√µ tay. V√≠ d·ª•:
ƒêB 86408
G7 50 41 65 99
G6 609 108 352"></textarea>
            <div class="btnbar" style="margin-top:8px">
              <button class="secondary" id="btnParseManual">Gate Manual</button>
              <button id="btnSaveManual">Save 1 ng√†y / 1 d√≤ng</button>
            </div>

            <div class="field">
              <label>Ng√†y (n·∫øu ƒë·ªÉ tr·ªëng: auto = h√¥m nay)</label>
              <input id="manualDate" type="date" />
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <h2>Preview batch</h2>
        <div class="preview" id="preview"></div>

        <div class="hr"></div>

        <div class="btnbar">
          <button id="btnRunOCR" disabled>Ch·∫°y OCR + Gate (Batch)</button>
          <button class="secondary" id="btnCheckPha" disabled>CHECK PHA (HardLock)</button>
          <button id="btnChot" disabled>CH·ªêT (6 d√≤ng + 1 anti)</button>
        </div>

        <p class="note" id="noteHint"></p>
      </div>

      <!-- RIGHT: Data + Pha output -->
      <div class="card">
        <h2>D·ªØ li·ªáu ƒë√£ l∆∞u (7‚Äì14 ng√†y)</h2>
        <p class="help">
          App d√πng <b>l√µi = (ƒëu√¥i ƒêB + l√µi G7)</b>. HardLock pha = c·ª©ng nh·∫•t: thi·∫øu ƒëi·ªÅu ki·ªán l√† STOP (kh√¥ng cho ch·ªët).
        </p>

        <table class="tbl" id="tblData">
          <thead>
            <tr>
              <th>Ng√†y</th>
              <th>ƒêB</th>
              <th>G7</th>
              <th>G6</th>
              <th class="right">Gate</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="hr"></div>

        <h2>K·∫øt lu·∫≠n</h2>
        <div class="bigmode">
          <div>
            <div class="tag" id="tagPha">PHA: ‚Äî</div>
            <div class="m" id="modeText">MODE: STOP</div>
            <div class="note" id="hardlockWhy">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
          </div>
          <div class="pct" id="phaPct">0%</div>
        </div>

        <div class="kq" style="margin-top:10px">
          <div class="line"><span>1) Pha ng√†y</span><span class="mono" id="out1">‚Äî</span></div>
          <div class="line"><span>2) H∆∞·ªõng ch√≠nh</span><span class="mono" id="out2">‚Äî</span></div>
          <div class="line"><span>3) Vai tr√≤ G6‚ÄìG7</span><span class="mono" id="out3">‚Äî</span></div>
          <div class="line"><span>4) Quy·∫øt ƒë·ªãnh</span><span class="mono" id="out4">‚Äî</span></div>
          <div class="line"><span>5) Ch·ªët</span><span class="mono" id="out5">‚Äî</span></div>
          <div class="line"><span>6) % tin c·∫≠y</span><span class="mono" id="out6">‚Äî</span></div>
          <div class="line"><span>Anti-b·∫´y (b·∫Øt bu·ªôc)</span><span class="mono" id="outAnti">‚Äî</span></div>
        </div>

        <div class="btnbar" style="margin-top:10px">
          <button class="secondary" id="btnCopy">Copy 6 d√≤ng</button>
          <button class="secondary" id="btnExport">Export JSON</button>
        </div>

        <p class="note">
          Tip an to√†n pha: n·∫øu HardLock fail ‚Üí ƒë·ª´ng √©p tr·ª•c. N·∫øu ‚ÄúBung bi√™n‚Äù tƒÉng ‚Üí coi l√† c·∫£nh b√°o.
        </p>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="wrap2">
      <div class="miniinfo">B√πi H√†o ‚Ä¢ Pha Safe Gate ‚Ä¢ L√µi=(ƒëu√¥i ƒêB + l√µi G7) ‚Ä¢ Offline data (localStorage)</div>
      <div class="miniinfo">N·∫øu mu·ªën PWA offline cache 100%: t·∫°o th√™m <span class="mono">sw.js</span> ri√™ng (m√¨nh g·ª≠i sau).</div>
    </div>
  </div>

<script>
/* =========================
   STORAGE + STATE
========================= */
const LS_KEY = "bh_ultra_db_pwa_v1";
const state = {
  images: [],   // {id, file, url, trimmedUrl, ocrText, parsed, gateOk}
  rows: [],     // {date, db5, db2, g7:[..], g6:[..], ok, note}
  lastPha: null // computed
};

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    state.rows = Array.isArray(obj.rows) ? obj.rows : [];
  }catch(e){}
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify({rows: state.rows}));
  updateSavePill();
}

/* =========================
   UI HELPERS
========================= */
const $ = (id)=>document.getElementById(id);
function setPill(id, text){ $(id).textContent = text; }

function updateStatus(){
  setPill("stBatch", String(state.images.length));
  setPill("stGate", state.images.length ? "ready" : "waiting");
  $("btnRunOCR").disabled = state.images.length === 0;
  $("btnCheckPha").disabled = state.rows.length < 3;
  $("btnChot").disabled = !state.lastPha || state.lastPha.mode === "STOP";
}
function updateSavePill(){
  setPill("stSave", state.rows.length ? `${state.rows.length} ng√†y` : "empty");
}
function setNote(msg){
  $("noteHint").textContent = msg || "";
}

/* =========================
   IMAGE PREVIEW + SAFE TRIM
========================= */
function fileToUrl(file){
  return new Promise((res)=>{
    const url = URL.createObjectURL(file);
    res(url);
  });
}

// Safe trim: crop top/bottom percentage via canvas.
async function trimImage(url, topPct, bottomPct){
  const img = new Image();
  img.crossOrigin = "anonymous";
  img.src = url;
  await img.decode();
  const c = document.createElement("canvas");
  const w = img.naturalWidth, h = img.naturalHeight;
  const top = Math.round(h * (topPct/100));
  const bottom = Math.round(h * (bottomPct/100));
  const y = Math.max(0, top);
  const hh = Math.max(1, h - top - bottom);
  c.width = w; c.height = hh;
  const ctx = c.getContext("2d");
  ctx.drawImage(img, 0, y, w, hh, 0, 0, w, hh);
  return c.toDataURL("image/jpeg", 0.92);
}

function renderPreview(){
  const pv = $("preview");
  pv.innerHTML = "";
  for(const it of state.images){
    const d = document.createElement("div");
    d.className = "thumb";
    const img = document.createElement("img");
    img.src = it.trimmedUrl || it.url;
    const badge = document.createElement("div");
    badge.className = "badge";
    const mini = document.createElement("span");
    mini.className = "mini " + (it.gateOk ? "ok" : it.gateOk === false ? "bad" : "warn");
    const txt = document.createElement("span");
    txt.textContent = it.gateOk ? "Gate OK" : it.gateOk === false ? "Gate FAIL" : "Pending";
    badge.appendChild(mini); badge.appendChild(txt);
    d.appendChild(img); d.appendChild(badge);
    pv.appendChild(d);
  }
  updateStatus();
}

/* =========================
   OCR + GATE PARSER
   Pattern rules (as you asked):
   - DB label ‚ÄúƒêB/DB‚Äù + 5 digits
   - G7: 4 numbers (2 digits)
   - G6: 3 numbers (3 digits) -> take last 2 digits each
========================= */
function normalizeText(t){
  return (t||"")
    .replace(/\r/g,"\n")
    .replace(/[^\S\n]+/g," ")
    .replace(/ƒêB/gi,"DB")  // unify
    .replace(/√êB/gi,"DB")
    .replace(/O/g,"0")     // OCR common confusion
    .replace(/I/g,"1")
    .replace(/l/g,"1")
    .replace(/S/g,"5");
}

// Extract DB 5 digits after DB label
function extractDB(text){
  const m = text.match(/\bDB\b[\s:]*([0-9]{5})\b/);
  if(m) return m[1];
  // fallback: sometimes OCR reads "DB 86408" across lines
  const m2 = text.match(/\bDB\b[\s:\n]*([0-9]{5})\b/);
  return m2 ? m2[1] : null;
}
function extractG7(text){
  // try labeled G7
  let m = text.match(/\bG7\b[\s:\n]*([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})/);
  if(m) return [m[1],m[2],m[3],m[4]];
  // fallback: find any line with 4 two-digit tokens
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){
    const mm = ln.match(/(?:^| )([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})\s+([0-9]{2})(?: |$)/);
    if(mm) return [mm[1],mm[2],mm[3],mm[4]];
  }
  return null;
}
function extractG6(text){
  // labeled G6: 3-digit x3
  let m = text.match(/\bG6\b[\s:\n]*([0-9]{3})\s+([0-9]{3})\s+([0-9]{3})/);
  if(m) return [m[1],m[2],m[3]];
  // fallback: find any line with three 3-digit tokens
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
  for(const ln of lines){
    const mm = ln.match(/(?:^| )([0-9]{3})\s+([0-9]{3})\s+([0-9]{3})(?: |$)/);
    if(mm) return [mm[1],mm[2],mm[3]];
  }
  return null;
}

function gateParse(raw){
  const text = normalizeText(raw);
  const db5 = extractDB(text);
  const g7 = extractG7(text);
  const g6 = extractG6(text);

  const ok = !!(db5 && g7 && g6);
  const out = {
    ok,
    db5,
    db2: db5 ? db5.slice(-2) : null,
    g7,
    g6,
    text
  };
  return out;
}

/* =========================
   L√ïI + PHA SAFE ENGINE (HardLock)
   L√µi = (ƒëu√¥i ƒêB + l√µi G7)
   - l√µi G7 = digit xu·∫•t hi·ªán nhi·ªÅu nh·∫•t trong 4 s·ªë G7 (t√≠nh theo ƒêU√îI)
   HardLock A/B/C:
   A Structure: c√≥ c·∫•u tr√∫c l·∫∑p trong 7 ng√†y (ƒë·∫ßu/ƒëu√¥i l·∫∑p ho·∫∑c t·ªïng l·∫∑p ƒë√¥i)
   B Anchor: G6 neo + G7 d√≠nh l√µi >=2/3 (3 ng√†y g·∫ßn nh·∫•t)
   C Anti-breakout: 3 ng√†y g·∫ßn nh·∫•t kh√¥ng ƒë·ªìng th·ªùi bung bi√™n m·∫°nh ·ªü G6/G7 v√† ƒêB bi√™n ho√°
========================= */
function digitsOf(str){ return String(str).split("").map(x=>Number(x)); }
function sum2(n2){
  if(!n2 || n2.length!==2) return null;
  return Number(n2[0])+Number(n2[1]);
}
function isDoubleSum(n2){
  const s = sum2(n2);
  if(s===null) return false;
  const ss = String(s);
  return ss.length===2 && ss[0]===ss[1]; // 11,22,33...
}
function tailDigit(n){ return Number(String(n).slice(-1)); }
function headDigit2(n2){ return Number(String(n2)[0]); }

function dominantTailDigitG7(g7){
  // g7: ["50","41","65","99"] => count tail digits
  const cnt = new Map();
  for(const x of g7){
    const d = tailDigit(x);
    cnt.set(d, (cnt.get(d)||0)+1);
  }
  // pick max; tie -> smaller digit
  let best = null, bestc=-1;
  for(const [d,c] of cnt.entries()){
    if(c>bestc || (c===bestc && d<best)){ best=d; bestc=c; }
  }
  return best; // 0..9
}

function lastNRows(n=7){
  const rows = [...state.rows].sort((a,b)=>a.date.localeCompare(b.date));
  return rows.slice(-n);
}

function structureLock(rows7){
  // Condition: at least 1 "structured repetition" in last 7 days:
  // - DB tail digit repeats >=2 times within last 3 days OR
  // - DB head digit repeats >=2 times within last 3 days OR
  // - double-sum appears >=1 within last 7 days
  if(rows7.length < 3) return {ok:false, why:"Thi·∫øu d·ªØ li·ªáu 3 ng√†y."};
  const r3 = rows7.slice(-3);
  const tails = r3.map(r=>tailDigit(r.db2));
  const heads = r3.map(r=>headDigit2(r.db2));
  const repTail = new Set(tails).size <= 2; // means at least one repeat
  const repHead = new Set(heads).size <= 2;

  const anyDoubleSum = rows7.some(r=>isDoubleSum(r.db2));

  const ok = (repTail || repHead || anyDoubleSum);
  const why = ok
    ? "C√≥ c·∫•u tr√∫c l·∫∑p (ƒëu√¥i/ƒë·∫ßu l·∫∑p ho·∫∑c t·ªïng l·∫∑p ƒë√¥i)."
    : "Ch∆∞a th·∫•y c·∫•u tr√∫c l·∫∑p r√µ trong 7 ng√†y.";
  return {ok, why, repTail, repHead, anyDoubleSum};
}

function anchorLock(rows3){
  // Need >=2/3 days:
  // - G6 neo 1 digit l√µi (ƒëu√¥i DB ho·∫∑c l√µi G7) xu·∫•t hi·ªán trong 3 s·ªë G6 (ƒëu√¥i 2 s·ªë)
  // - G7 d√≠nh l√µi: 4 s·ªë G7 c√≥ ƒëu√¥i tr√πng digit l√µi G7 ho·∫∑c digit ƒëu√¥i DB
  if(rows3.length < 3) return {ok:false, why:"Thi·∫øu d·ªØ li·ªáu 3 ng√†y."};

  let g6Hit=0, g7Hit=0;
  for(const r of rows3){
    const dbTail = tailDigit(r.db2);
    const g7Dom = dominantTailDigitG7(r.g7);
    const core = new Set([dbTail, g7Dom]);

    // G6 check: take last 2 digits each then tail digits
    const g6_2 = r.g6.map(x=>String(x).slice(-2));
    const g6_tails = g6_2.map(tailDigit);
    const g6_ok = g6_tails.some(d=>core.has(d));
    if(g6_ok) g6Hit++;

    // G7 check: tails among 4 g7
    const g7_tails = r.g7.map(tailDigit);
    const g7_ok = g7_tails.some(d=>core.has(d));
    if(g7_ok) g7Hit++;
  }
  const ok = (g6Hit>=2 && g7Hit>=2);
  const why = ok
    ? `Neo ƒë·∫°t: G6 neo ${g6Hit}/3, G7 d√≠nh l√µi ${g7Hit}/3.`
    : `Neo y·∫øu: G6 neo ${g6Hit}/3, G7 d√≠nh l√µi ${g7Hit}/3.`;
  return {ok, why, g6Hit, g7Hit};
}

function breakoutPressure(rows3){
  // "Bung bi√™n m·∫°nh" if many 0/9 tails in G7/G6 on same day
  // and DB bi√™n ho√° (db2 head or tail in {0,9}).
  // BreakoutLock FAIL if >=1 day in last 3 meets BOTH conditions.
  const BIEN = new Set([0,9]);
  let badDays = 0;
  for(const r of rows3){
    const dbHead = headDigit2(r.db2);
    const dbTail = tailDigit(r.db2);
    const dbBien = BIEN.has(dbHead) || BIEN.has(dbTail);

    const g7BienCount = r.g7.map(tailDigit).filter(d=>BIEN.has(d)).length;
    const g6BienCount = r.g6.map(x=>tailDigit(String(x).slice(-2))).filter(d=>BIEN.has(d)).length;

    const bung = (g7BienCount + g6BienCount) >= 3; // strong
    if(dbBien && bung) badDays++;
  }
  const ok = (badDays===0);
  const why = ok ? "Kh√¥ng th·∫•y breakout bi√™n nguy hi·ªÉm trong 3 ng√†y." : `C·∫£nh b√°o breakout bi√™n: ${badDays}/3 ng√†y.`;
  return {ok, why, badDays};
}

function classifyPha(rows){
  // HardLock requires A+B+C.
  const rows7 = rows.slice(-7);
  const rows3 = rows.slice(-3);
  const A = structureLock(rows7);
  const B = anchorLock(rows3);
  const C = breakoutPressure(rows3);

  const hardOk = A.ok && B.ok && C.ok;

  // Confidence score:
  // Structure 0/30, Anchor 0/40, Breakout 0/30 (penalty)
  let score = 0;
  score += A.ok ? 30 : 10;
  score += B.ok ? 40 : Math.max(0, (B.g6Hit||0)*8 + (B.g7Hit||0)*6); // partial
  score += C.ok ? 30 : 10;
  score = Math.max(0, Math.min(100, score));

  // Determine M1/M2/M3 using safest logic
  let pha = "M1";
  let mode = "STOP";

  if(!hardOk){
    pha = "M1";
    mode = "STOP";
  }else{
    // check "li·ªÅn nh·ªãp" core across last 2 days using (dbTail + g7Dom)
    if(rows.length >= 2){
      const r1 = rows[rows.length-2];
      const r2 = rows[rows.length-1];
      const c1 = `${tailDigit(r1.db2)}-${dominantTailDigitG7(r1.g7)}`;
      const c2 = `${tailDigit(r2.db2)}-${dominantTailDigitG7(r2.g7)}`;
      const lien = (c1 === c2);
      if(lien && score>=80){
        pha = "M3";
        mode = "SIEÃÇÃÅT";
      }else{
        pha = "M2";
        mode = "LIGHT";
      }
    }else{
      pha = "M2";
      mode = "LIGHT";
    }
  }

  // Build why
  const why = [
    `A(Structure): ${A.ok ? "OK" : "FAIL"} ‚Äî ${A.why}`,
    `B(Anchor): ${B.ok ? "OK" : "FAIL"} ‚Äî ${B.why}`,
    `C(Breakout): ${C.ok ? "OK" : "FAIL"} ‚Äî ${C.why}`
  ].join(" | ");

  return { pha, mode, score, hardOk, why, A, B, C };
}

/* =========================
   CH·ªêT OUTPUT (6 lines + 1 anti)
   - If STOP: no ch·ªët
   - LIGHT: 2 s·ªë + anti
   - SI·∫æT: 1 con (1 c·∫∑p) + anti
   Ch·ªët d·ª±a tr√™n l√µi=(ƒëu√¥i ƒêB + l√µi G7)
========================= */
function pickAnti(rows){
  // Anti priority:
  // 1) If bi√™n pressure rising -> choose one from 09/90/00/99 not seen last 3 days
  // 2) Else anti = ƒë·∫£o c·ªßa db2 (reverse)
  const last3 = rows.slice(-3);
  const seen = new Set(last3.map(r=>r.db2).concat(last3.flatMap(r=>r.g7)));
  const bienSet = ["09","90","00","99"];
  const C = breakoutPressure(last3);
  if(!C.ok){
    for(const x of bienSet){
      if(!seen.has(x)) return x;
    }
    return "09";
  }
  const last = rows[rows.length-1];
  const db2 = last.db2;
  const rev = db2[1]+db2[0];
  return rev;
}

function pickChot(rows, pha){
  const last = rows[rows.length-1];
  const dbTail = tailDigit(last.db2);        // digit
  const g7Dom = dominantTailDigitG7(last.g7);// digit
  const a = `${dbTail}${g7Dom}`.padStart(2,"0");
  const b = `${g7Dom}${dbTail}`.padStart(2,"0");

  // choose one based on parity trend from last 3 DB:
  const last3 = rows.slice(-3).map(r=>Number(r.db2)%2); // 0 even 1 odd
  const oddCount = last3.reduce((s,x)=>s+x,0);
  const preferOdd = oddCount<=1; // if mostly even recently, prefer odd to balance, else even
  const cand = [a,b];
  let pick = cand[0];
  for(const c of cand){
    const isOdd = (Number(c)%2===1);
    if(preferOdd && isOdd) { pick = c; break; }
    if(!preferOdd && !isOdd){ pick = c; break; }
  }

  // For SI·∫æT: return 1 c·∫∑p. For LIGHT: return 2 s·ªë (pair)
  if(pha.mode === "SIEÃÇÃÅT"){
    return {chot: pick, bundle:[pick]};
  }
  // LIGHT
  const other = (pick===a)?b:a;
  return {chot: `${pick} ${other}`, bundle:[pick, other]};
}

function computeHuong(rows, pha){
  // Minimal: core digits + warning on bi√™n
  const last = rows[rows.length-1];
  const dbTail = tailDigit(last.db2);
  const g7Dom = dominantTailDigitG7(last.g7);
  const core = `${dbTail}-${g7Dom}`;
  const C = breakoutPressure(rows.slice(-3));
  const huong = C.ok ? `L√µi b√°m ${core} (ƒëu√¥i ƒêB + l√µi G7)` : `C·∫£nh b√°o bi√™n; ∆∞u ti√™n l√µi ${core} nh∆∞ng kh√≥a anti`;
  return huong;
}

function build6Lines(){
  if(state.rows.length < 3){
    return null;
  }
  const rows = [...state.rows].sort((a,b)=>a.date.localeCompare(b.date));
  const pha = classifyPha(rows);
  state.lastPha = pha;

  const anti = pickAnti(rows);
  const ch = pickChot(rows, pha);
  const huong = computeHuong(rows, pha);

  // Vai tr√≤ G6‚ÄìG7 short
  const last = rows[rows.length-1];
  const dbTail = tailDigit(last.db2);
  const g7Dom = dominantTailDigitG7(last.g7);
  const role = `G7 d√≠nh l√µi=${g7Dom} | G6 neo theo l√µi=${dbTail}/${g7Dom}`;

  // Quy·∫øt ƒë·ªãnh
  let decision = "D·ª™NG";
  if(pha.mode==="LIGHT") decision = "CH∆†I NH·∫∏ (2 s·ªë)";
  if(pha.mode==="SIEÃÇÃÅT") decision = "CH∆†I (ƒë∆∞·ª£c si·∫øt 1 con)";

  // % tin c·∫≠y
  const pct = `${pha.score}%`;

  // Output mapping (exact format feel)
  $("out1").textContent = `${pha.pha} ‚Ä¢ ${pha.mode}`;
  $("out2").textContent = huong;
  $("out3").textContent = role;
  $("out4").textContent = decision;
  $("out5").textContent = (pha.mode==="STOP") ? "‚Äî" : ch.chot;
  $("out6").textContent = pct;
  $("outAnti").textContent = anti;

  // Right panel header
  $("tagPha").textContent = `PHA: ${pha.pha}`;
  $("modeText").textContent = `MODE: ${pha.mode}`;
  $("phaPct").textContent = pct;
  $("hardlockWhy").textContent = pha.why;

  // Enable/disable ch·ªët
  $("btnChot").disabled = (pha.mode==="STOP");

  return {pha, anti, ch};
}

/* =========================
   TABLE RENDER
========================= */
function renderTable(){
  const tb = $("tblData").querySelector("tbody");
  tb.innerHTML = "";
  const rows = [...state.rows].sort((a,b)=>a.date.localeCompare(b.date));
  for(const r of rows){
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="mono">${r.date}</td>
      <td class="mono">${r.db5 || ""} <span class="tag">(${r.db2||""})</span></td>
      <td class="mono">${(r.g7||[]).join(" ")}</td>
      <td class="mono">${(r.g6||[]).join(" ")}</td>
      <td class="right">${r.ok ? "‚úÖ" : "‚ùå"}</td>
    `;
    tb.appendChild(tr);
  }
  updateSavePill();
  updateStatus();
}

/* =========================
   SAVE 1 NG√ÄY / 1 D√íNG
========================= */
function todayISO(){
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,"0");
  const dd = String(d.getDate()).padStart(2,"0");
  return `${yyyy}-${mm}-${dd}`;
}
function upsertRow(row){
  // unique by date
  const idx = state.rows.findIndex(x=>x.date===row.date);
  if(idx>=0) state.rows[idx] = row;
  else state.rows.push(row);
  // keep <= 20 days
  state.rows = state.rows.sort((a,b)=>a.date.localeCompare(b.date)).slice(-20);
  saveState();
  renderTable();
}

/* =========================
   EVENTS
========================= */
$("btnUpload").addEventListener("click", ()=> $("fileInput").click());
$("btnCamera").addEventListener("click", ()=> $("camInput").click());

$("fileInput").addEventListener("change", async (e)=>{
  const files = [...e.target.files||[]];
  await addFiles(files);
  e.target.value = "";
});
$("camInput").addEventListener("change", async (e)=>{
  const files = [...e.target.files||[]];
  await addFiles(files);
  e.target.value = "";
});

async function addFiles(files){
  if(!files.length) return;
  setPill("stOCR","idle");
  setNote(`ƒê√£ nh·∫≠n ${files.length} ·∫£nh. B·∫•m ‚ÄúCh·∫°y OCR + Gate (Batch)‚Äù.`);
  const topPct = Number($("trimTop").value||12);
  const bottomPct = Number($("trimBottom").value||12);

  for(const f of files){
    const url = await fileToUrl(f);
    const trimmedUrl = await trimImage(url, topPct, bottomPct);
    state.images.push({
      id: crypto.randomUUID(),
      file: f,
      url,
      trimmedUrl,
      ocrText: "",
      parsed: null,
      gateOk: null
    });
  }
  renderPreview();
}

$("btnRebuildThumbs").addEventListener("click", async ()=>{
  const topPct = Number($("trimTop").value||12);
  const bottomPct = Number($("trimBottom").value||12);
  for(const it of state.images){
    it.trimmedUrl = await trimImage(it.url, topPct, bottomPct);
    it.gateOk = null;
    it.parsed = null;
    it.ocrText = "";
  }
  setNote("ƒê√£ √°p trim. B·∫•m OCR ƒë·ªÉ gate l·∫°i.");
  renderPreview();
});

$("btnReset").addEventListener("click", ()=>{
  if(!confirm("RESET S·∫†CH: xo√° batch ·∫£nh + xo√° d·ªØ li·ªáu ƒë√£ l∆∞u (localStorage). OK?")) return;
  state.images.forEach(it=>{ try{URL.revokeObjectURL(it.url);}catch(e){} });
  state.images = [];
  state.rows = [];
  state.lastPha = null;
  localStorage.removeItem(LS_KEY);
  $("preview").innerHTML = "";
  $("manualText").value = "";
  renderTable();
  build6Lines();
  setPill("stGate","waiting");
  setPill("stOCR","idle");
  updateStatus();
  setNote("ƒê√£ reset s·∫°ch.");
});

$("btnPasteSample").addEventListener("click", ()=>{
  $("manualText").value = `DB 86408
G7 50 41 65 99
G6 609 108 352`;
  setNote("ƒê√£ d√°n m·∫´u. B·∫•m ‚ÄúGate Manual‚Äù r·ªìi ‚ÄúSave 1 ng√†y / 1 d√≤ng‚Äù.");
});

$("btnParseManual").addEventListener("click", ()=>{
  const parsed = gateParse($("manualText").value);
  if(parsed.ok){
    setPill("stGate","manual: OK");
    setNote(`Gate OK: DB=${parsed.db5} | G7=${parsed.g7.join(" ")} | G6=${parsed.g6.join(" ")}`);
  }else{
    setPill("stGate","manual: FAIL");
    setNote("Gate FAIL: c·∫ßn ƒë√∫ng DB + 5 s·ªë, G7 4 s·ªë 2 ch·ªØ s·ªë, G6 3 s·ªë 3 ch·ªØ s·ªë.");
  }
  $("manualText").dataset.parsed = JSON.stringify(parsed);
});

$("btnSaveManual").addEventListener("click", ()=>{
  let parsed = null;
  try{ parsed = JSON.parse($("manualText").dataset.parsed||"null"); }catch(e){}
  if(!parsed || !parsed.ok){
    alert("Ch∆∞a Gate OK. B·∫•m ‚ÄúGate Manual‚Äù tr∆∞·ªõc.");
    return;
  }
  const date = $("manualDate").value || todayISO();
  upsertRow({
    date,
    db5: parsed.db5,
    db2: parsed.db2,
    g7: parsed.g7,
    g6: parsed.g6,
    ok: true,
    note: "manual"
  });
  setNote(`ƒê√£ save ${date}. B·∫•m CHECK PHA.`);
  updateStatus();
});

$("btnRunOCR").addEventListener("click", async ()=>{
  if(!state.images.length) return;
  setPill("stOCR","running");
  setNote("ƒêang OCR‚Ä¶ (tu·ª≥ m√°y c√≥ th·ªÉ m·∫•t ch√∫t).");

  // OCR sequential to be stable on mobile
  for(let i=0;i<state.images.length;i++){
    const it = state.images[i];
    const src = it.trimmedUrl || it.url;
    try{
      const res = await Tesseract.recognize(src, "eng", { logger: ()=>{} });
      it.ocrText = res.data.text || "";
      it.parsed = gateParse(it.ocrText);
      it.gateOk = !!it.parsed.ok;
    }catch(e){
      it.ocrText = "";
      it.parsed = {ok:false, text:""};
      it.gateOk = false;
    }
    renderPreview();
    setNote(`OCR ${i+1}/${state.images.length}: ${it.gateOk ? "Gate OK" : "Gate FAIL"}`);
  }

  setPill("stOCR","done");
  setNote("OCR xong. Ch·ªçn ·∫£nh gate OK ‚Üí Save (t·ª±).");
  // Auto-save each OK image to consecutive days? (dangerous) => safer: save into "pending list" via prompt:
  const okCount = state.images.filter(x=>x.gateOk).length;
  if(okCount){
    if(confirm(`C√≥ ${okCount} ·∫£nh Gate OK. B·∫°n mu·ªën AUTO SAVE theo th·ª© t·ª±: m·ªói ·∫£nh = 1 ng√†y (t·ª± tƒÉng ng√†y t·ª´ h√¥m nay l√πi v·ªÅ tr∆∞·ªõc)?\n(OK = t·ª± l∆∞u, Cancel = b·∫°n t·ª± Manual Save t·ª´ng ng√†y)`)){
      const base = new Date();
      // newest image = today, next = yesterday...
      const okImgs = state.images.filter(x=>x.gateOk);
      for(let j=0;j<okImgs.length;j++){
        const d = new Date(base);
        d.setDate(base.getDate() - j);
        const date = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
        const p = okImgs[j].parsed;
        upsertRow({date, db5:p.db5, db2:p.db2, g7:p.g7, g6:p.g6, ok:true, note:"ocr"});
      }
      setNote("ƒê√£ auto-save. B·∫•m CHECK PHA.");
      updateStatus();
    }
  }else{
    setNote("Kh√¥ng c√≥ ·∫£nh Gate OK. D√πng Manual nh√©.");
  }
});

$("btnCheckPha").addEventListener("click", ()=>{
  if(state.rows.length < 3){
    alert("C·∫ßn t·ªëi thi·ªÉu 3 ng√†y d·ªØ li·ªáu.");
    return;
  }
  build6Lines();
  updateStatus();
});

$("btnChot").addEventListener("click", ()=>{
  const out = build6Lines();
  if(!out) return;
  if(out.pha.mode==="STOP"){
    alert("STOP: Pha ch∆∞a kh√≥a, kh√¥ng ch·ªët.");
    return;
  }
  setNote("ƒê√£ d·ª±ng ch·ªët theo PHA SAFE. Copy 6 d√≤ng ƒë·ªÉ note.");
});

$("btnCopy").addEventListener("click", async ()=>{
  const lines = [
    `1) ${$("out1").textContent}`,
    `2) ${$("out2").textContent}`,
    `3) ${$("out3").textContent}`,
    `4) ${$("out4").textContent}`,
    `5) ${$("out5").textContent}`,
    `6) ${$("out6").textContent}`,
    `Anti: ${$("outAnti").textContent}`
  ].join("\n");
  try{
    await navigator.clipboard.writeText(lines);
    setNote("ƒê√£ copy 6 d√≤ng + anti v√†o clipboard.");
  }catch(e){
    alert("Kh√¥ng copy ƒë∆∞·ª£c (tr√¨nh duy·ªát ch·∫∑n). B·∫°n copy th·ªß c√¥ng ·ªü panel K·∫øt lu·∫≠n.");
  }
});

$("btnExport").addEventListener("click", ()=>{
  const payload = {
    rows: state.rows,
    pha: state.lastPha || null
  };
  const blob = new Blob([JSON.stringify(payload,null,2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "bh_soi_db_export.json";
  a.click();
  URL.revokeObjectURL(url);
});

/* =========================
   INIT
========================= */
loadState();
renderTable();
updateStatus();
updateSavePill();
setNote("Tip: n·∫øu OCR fail th√¨ d√πng Manual. Khi ƒë·ªß 3 ng√†y ‚Üí CHECK PHA ƒë·ªÉ kh√≥a an to√†n.");
</script>
</body>
</html>
