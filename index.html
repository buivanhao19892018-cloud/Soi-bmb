<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (V4 ‚Ä¢ 2-ZONE OCR ‚Ä¢ QUARANTINE+VOTE ‚Ä¢ PHA SAFE ‚Ä¢ SOI&CH·ªêT)</title>
  <meta name="theme-color" content="#0b1320" />
  <style>
    :root{
      --bg:#0b1320; --card:#111c2e; --card2:#0f1a2b;
      --text:#e8f0ff; --muted:#9cb3d6;
      --ok:#30d158; --warn:#ffd60a; --bad:#ff453a; --info:#64d2ff;
      --btn:#1d3b6b; --btn2:#203f75; --chip:#162844;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); background:radial-gradient(1200px 600px at 70% -10%, #163a7a33, transparent 60%),
      radial-gradient(900px 500px at 10% 0%, #1f7a5a22, transparent 55%),
      var(--bg);
      color:var(--text);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}
    .hero{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:24px; padding:18px 16px; box-shadow:var(--shadow);
      position:sticky; top:0; z-index:4; backdrop-filter: blur(10px);
    }
    h1{margin:0 0 6px;font-size:20px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px;line-height:1.35}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08); font-size:12px; color:var(--muted)
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)} .dot.info{background:var(--info)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:14px}
    @media(min-width:860px){ .grid{grid-template-columns:1.2fr .8fr} }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--r); padding:14px; box-shadow:var(--shadow)
    }
    .card h2{margin:0 0 10px;font-size:15px}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
    button{
      border:0; cursor:pointer; color:var(--text);
      padding:11px 14px;border-radius:14px;background:linear-gradient(180deg,var(--btn2),var(--btn));
      box-shadow:0 10px 20px rgba(0,0,0,.25);
      font-weight:700; letter-spacing:.2px;
    }
    button.secondary{
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1);
      box-shadow:none; font-weight:650
    }
    button.danger{
      background:linear-gradient(180deg,#7a1b1b,#551515);
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    input, textarea, select{
      width:100%; padding:12px 12px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.25);
      color:var(--text); outline:none
    }
    textarea{min-height:92px; font-family:var(--mono); font-size:12px; line-height:1.35}
    .kpi{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px}
    .kpi .box{
      background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:12px
    }
    .kpi .big{font-size:28px;font-weight:800;letter-spacing:.3px}
    .kpi .lab{color:var(--muted);font-size:12px;margin-top:4px}
    .pill{display:inline-flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .pill span{
      font-size:12px;color:var(--muted);
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.08);
      padding:7px 10px;border-radius:999px
    }
    .seg{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .seg button{padding:9px 11px;border-radius:999px;font-weight:750}
    .seg button.active{outline:2px solid rgba(100,210,255,.45)}
    .previewWrap{
      margin-top:12px; border-radius:18px; overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.22)
    }
    canvas{display:block;width:100%;height:auto}
    .mono{font-family:var(--mono)}
    .log{
      white-space:pre-wrap; font-family:var(--mono);
      font-size:12px; line-height:1.4; color:#d7e6ff
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.20); font-size:12px; color:var(--muted)
    }
    .badge strong{color:var(--text)}
    .statusLine{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .toast{
      position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
      background:rgba(0,0,0,.78); border:1px solid rgba(255,255,255,.16);
      color:var(--text); padding:10px 12px;border-radius:12px; z-index:99;
      font-size:13px; max-width:min(720px,92vw);
      box-shadow:var(--shadow); display:none
    }
    .small{font-size:12px;color:var(--muted)}
    .okTxt{color:var(--ok)} .badTxt{color:var(--bad)} .warnTxt{color:var(--warn)} .infoTxt{color:var(--info)}
  </style>

  <!-- Tesseract.js (CDN). N·∫øu mu·ªën OFFLINE: t·∫£i file v·ªÅ v√† ƒë·ªïi src -->
  <script src="https://unpkg.com/tesseract.js@5.1.0/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>B√πi H√†o ‚Äî Lotto ULTRA MASTER (V4 ‚Ä¢ 2-ZONE OCR ‚Ä¢ QUARANTINE+VOTE ‚Ä¢ PHA SAFE ‚Ä¢ SOI&CH·ªêT)</h1>
      <div class="sub">
        Lu·ªìng cao nh·∫•t: <b>StartDate</b> ‚Üí <b>Preprocess</b> (trim/contrast/scale) ‚Üí <b>OCR 2-ZONE</b> (DB ri√™ng / BOTTOM ri√™ng) ‚Üí <b>Rescue multi-pass</b> ‚Üí <b>Vote</b> ‚Üí <b>Gate DB/G7/G6</b> ‚Üí <b>Quarantine FAIL</b> ‚Üí <b>Commit timeline theo ng√†y</b> ‚Üí <b>PHA SAFE</b> ‚Üí <b>SOI & CH·ªêT H∆Ø·ªöNG</b>. Thi·∫øu/kh√¥ng ch·∫Øc ‚Üí <b>STOP</b>.
      </div>
      <div class="row">
        <span class="chip"><span class="dot ok"></span>2-ZONE OCR</span>
        <span class="chip"><span class="dot ok"></span>Rescue Presets</span>
        <span class="chip"><span class="dot info"></span>Vote + Score</span>
        <span class="chip"><span class="dot warn"></span>Quarantine FAIL</span>
        <span class="chip"><span class="dot ok"></span>Commit DayPointer</span>
        <span class="chip"><span class="dot ok"></span>PHA SAFE HardLock</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <h2>1) Nh·∫≠p ·∫£nh</h2>
        <div class="hint">
          M·∫πo ·∫£nh: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB/DB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab (Mi·ªÅn B·∫Øc/Trung/Nam) & header qu·∫£ng c√°o.
          N·∫øu ·∫£nh ‚Äúd√≠nh‚Äù nhi·ªÅu th·ª© ‚Üí b·∫≠t Rescue Presets / d√πng Manual Fix.
        </div>

        <div class="controls">
          <input id="files" type="file" accept="image/*" multiple />
          <button class="secondary" id="btnSample">D√°n m·∫´u</button>
          <button class="danger" id="btnReset">RESET S·∫†CH</button>
          <button id="btnRun">‚ö° CH·∫†Y FULL</button>
        </div>

        <div class="kpi">
          <div class="box"><div class="big" id="kOK">0</div><div class="lab">Batch OK (commit)</div></div>
          <div class="box"><div class="big" id="kFail">0</div><div class="lab">Batch FAIL (quarantine)</div></div>
          <div class="box"><div class="big" id="kDays">0</div><div class="lab">Save (ng√†y s·∫°ch)</div></div>
          <div class="box"><div class="big" id="kConf">0%</div><div class="lab">PHA Confidence (t·ª´ chu·ªói s·∫°ch)</div></div>
        </div>

        <div class="divider"></div>

        <div class="controls" style="gap:12px">
          <div style="flex:1;min-width:240px">
            <div class="small">StartDate (b·∫Øt bu·ªôc ‚Äî YYYY-MM-DD)</div>
            <input id="startDate" placeholder="2026-02-28" />
            <div class="small" style="margin-top:6px">
              <b>ULTRA rule:</b> ch·ªâ <b>commit</b> ng√†y khi Gate OK. ·∫¢nh FAIL ‚Üí <b>Quarantine</b> (kh√¥ng tƒÉng dayPointer).
            </div>
          </div>
          <div style="flex:1;min-width:240px">
            <div class="small">Manual Fix (DB|G7|G6) ‚Äî d√°n khi OCR l·ªách</div>
            <input id="manualFix" placeholder='VD: DB=83 | G7=57 42 39 13 | G6=247 554 108' />
            <div class="small" style="margin-top:6px">
              Ch·ªâ d√πng khi Gate fail / OCR r√°c. <b>Kh√¥ng ‚Äúƒëo√°n d·ªØ li·ªáu‚Äù</b>.
            </div>
          </div>
        </div>

        <div class="controls" style="margin-top:10px">
          <button class="secondary" id="btnRescue">üõü Rescue presets (t·ª± ch·∫°y 6 pass)</button>
          <button class="secondary" id="btnExport">‚¨á Export JSON</button>
          <button class="secondary" id="btnImport">‚¨Ü Import JSON</button>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
        </div>

        <div class="divider"></div>

        <h2>2) Preview (auto-trim + 2-ZONE)</h2>
        <div class="seg">
          <button class="secondary active" data-tab="all" id="tabAll">Preview t·ªïng</button>
          <button class="secondary" data-tab="db" id="tabDB">DB-zone</button>
          <button class="secondary" data-tab="bt" id="tabBT">BOTTOM-zone</button>
        </div>
        <div class="previewWrap">
          <canvas id="cv"></canvas>
        </div>

        <div class="pill">
          <span>DB-zone: t·ª´ ‚ÄúƒêB/DB‚Äù ƒë·∫øn h·∫øt G2</span>
          <span>BOTTOM-zone: t·ª´ G4/G5 xu·ªëng G6/G7</span>
          <span>Vote: score pattern + conf</span>
          <span>Commit: Gate OK m·ªõi l∆∞u ng√†y</span>
        </div>

        <div class="divider"></div>

        <h2>3) OCR Raw (vote winner)</h2>
        <textarea id="ocrDB" placeholder="OCR Raw ‚Äî DB zone"></textarea>
        <textarea id="ocrBT" placeholder="OCR Raw ‚Äî BOTTOM zone" style="margin-top:10px"></textarea>

        <div class="divider"></div>

        <h2>4) Gate Output (commit/quarantine)</h2>
        <div class="log" id="gateOut">‚Äî</div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <h2>PHA SAFE ‚Ä¢ SOI & CH·ªêT H∆Ø·ªöNG (6 d√≤ng)</h2>
        <div class="hint">
          Nguy√™n t·∫Øc: <b>OCR s·∫°ch ‚Üí Gate ƒë√∫ng ‚Üí chu·ªói s·∫°ch ‚â• 3 ng√†y ‚Üí m·ªõi m·ªü PHA</b>.  
          N·∫øu nhi·ªÖu / thi·∫øu l√µi / bung bi√™n m·∫°nh ‚Üí <b>STOP</b> (∆∞u ti√™n anti).  
          Format ch·ªët ƒë√∫ng y√™u c·∫ßu H√†o: <b>6 d√≤ng</b>, ch·ªët tr∆∞·ªõc gi·∫£i th√≠ch sau.
        </div>

        <div class="statusLine">
          <span class="badge"><strong>HardLock</strong> <span id="hardLockTxt" class="okTxt">ON</span></span>
          <span class="badge"><strong>Quarantine</strong> <span id="qTxt" class="warnTxt">Active</span></span>
          <span class="badge"><strong>Core</strong> <span id="coreTxt" class="infoTxt">ƒëu√¥i ƒêB + l√µi G7</span></span>
        </div>

        <div class="divider"></div>

        <h2>Chu·ªói ƒë√£ l∆∞u (theo ng√†y) ‚Äî ch·ªâ ng√†y ‚Äúcommit s·∫°ch‚Äù</h2>
        <div class="log" id="savedList">‚Äî</div>

        <div class="divider"></div>

        <h2>Quarantine (FAIL) ‚Äî kh√¥ng ƒë·ª•ng timeline</h2>
        <div class="log" id="quarantineList">‚Äî</div>

        <div class="divider"></div>

        <h2>SOI & CH·ªêT H∆Ø·ªöNG (6 d√≤ng)</h2>
        <div class="log" id="chot6">Ch∆∞a ƒë·ªß d·ªØ li·ªáu s·∫°ch (c·∫ßn ‚â• 3 ng√†y commit).</div>

        <div class="controls" style="margin-top:12px">
          <button id="btnAnalyze">üìå PH√ÇN T√çCH & CH·ªêT</button>
        </div>

        <div class="divider"></div>

        <h2>Checklist ch·ªëng l·ªách ng√†y / l·ªách pha</h2>
        <div class="hint">
          ‚Ä¢ Ng√†y tƒÉng ƒë√∫ng th·ª© t·ª±: <b>StartDate + s·ªë l·∫ßn commit</b> (FAIL kh√¥ng tƒÉng).<br/>
          ‚Ä¢ M·ªói ng√†y: ph·∫£i c√≥ <b>DB(2)</b> + <b>G7(4)</b> + <b>G6(3)</b>.<br/>
          ‚Ä¢ G7/G6 OCR l·∫´n G4/G5 ‚Üí score th·∫•p ‚Üí <b>Vote lo·∫°i</b> / ƒë∆∞a v√†o Quarantine.<br/>
          ‚Ä¢ Anti-b·∫´y: khi ‚Äúbung bi√™n / thi·∫øu l√µi / nhi·ªÖu cao‚Äù ‚Üí <b>STOP</b>.
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* =========================
   ULTRA V4 ‚Äî CORE
   - 2-ZONE OCR (DB zone / BOTTOM zone)
   - Rescue multi-pass + vote
   - Gate strict: DB2 + G7(4x2digits) + G6(3x3digits)
   - Quarantine FAIL (no dayPointer++)
   - Commit OK -> save by computed day
   - PHA SAFE + SOI & CH·ªêT 6 d√≤ng (TH + anti)
   ========================= */

const $ = (id)=>document.getElementById(id);
const state = {
  tab:'all',
  images:[], // {file, img, name}
  currentIndex:0,
  running:false,
  ok:0, fail:0,
  storeKey:'BH_ULTRA_V4_STORE',
  qKey:'BH_ULTRA_V4_QUAR',
  hardLock:true,
  // trim presets for auto-trim (top, bottom) as percentage of height
  presets:[
    {name:'P0', top:.12, bot:.12, scale:1.6, contrast:1.05, sharp:0.0},
    {name:'P1', top:.10, bot:.14, scale:1.8, contrast:1.10, sharp:0.0},
    {name:'P2', top:.14, bot:.10, scale:1.8, contrast:1.12, sharp:0.0},
    {name:'P3', top:.16, bot:.14, scale:2.0, contrast:1.15, sharp:0.0},
    {name:'P4', top:.08, bot:.16, scale:2.0, contrast:1.12, sharp:0.0},
    {name:'P5', top:.18, bot:.10, scale:2.2, contrast:1.18, sharp:0.0},
  ]
};

// ===== Storage helpers
function loadStore(){
  try{ return JSON.parse(localStorage.getItem(state.storeKey) || '[]'); }catch(e){ return []; }
}
function saveStore(arr){ localStorage.setItem(state.storeKey, JSON.stringify(arr)); }
function loadQuar(){
  try{ return JSON.parse(localStorage.getItem(state.qKey) || '[]'); }catch(e){ return []; }
}
function saveQuar(arr){ localStorage.setItem(state.qKey, JSON.stringify(arr)); }

function toast(msg){
  const t=$('toast');
  t.textContent=msg;
  t.style.display='block';
  clearTimeout(t._to);
  t._to=setTimeout(()=>t.style.display='none', 2400);
}

// ===== Date helpers
function parseDateISO(s){
  if(!/^\d{4}-\d{2}-\d{2}$/.test((s||'').trim())) return null;
  const [Y,M,D]=s.split('-').map(Number);
  const dt=new Date(Date.UTC(Y, M-1, D));
  if(dt.getUTCFullYear()!==Y || dt.getUTCMonth()!==M-1 || dt.getUTCDate()!==D) return null;
  return dt;
}
function fmtDate(dt){
  const y=dt.getUTCFullYear();
  const m=String(dt.getUTCMonth()+1).padStart(2,'0');
  const d=String(dt.getUTCDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function addDays(dt, n){
  const t=new Date(dt.getTime());
  t.setUTCDate(t.getUTCDate()+n);
  return t;
}

// ===== Image & canvas helpers
const cv=$('cv'), ctx=cv.getContext('2d');

function setTab(tab){
  state.tab=tab;
  $('tabAll').classList.toggle('active', tab==='all');
  $('tabDB').classList.toggle('active', tab==='db');
  $('tabBT').classList.toggle('active', tab==='bt');
  renderPreview();
}
['tabAll','tabDB','tabBT'].forEach(id=>{
  $(id).addEventListener('click', ()=> setTab($(id).dataset.tab));
});

function fitCanvas(w,h){
  cv.width=w; cv.height=h;
}
function drawImageContain(img){
  const maxW=cv.clientWidth || 800;
  const scale=maxW/img.width;
  const w=Math.max(1, Math.floor(img.width*scale));
  const h=Math.max(1, Math.floor(img.height*scale));
  fitCanvas(w,h);
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(img,0,0,w,h);
}

function getZones(img, preset){
  // work in full-res offscreen (better OCR)
  const W = img.width, H = img.height;
  const topCut = Math.floor(H * (preset?.top ?? 0.12));
  const botCut = Math.floor(H * (preset?.bot ?? 0.12));
  const y0 = topCut;
  const y1 = H - botCut;
  const Htrim = Math.max(10, y1 - y0);

  // DB-zone: roughly from "ƒêB/DB" down to end G2
  // Heuristic: upper 45% of trimmed area
  const dbY = y0;
  const dbH = Math.floor(Htrim * 0.48);

  // Bottom-zone: roughly from G4/G5 down to G7 (lower 55% of trimmed area)
  const btY = y0 + Math.floor(Htrim * 0.45);
  const btH = (y0 + Htrim) - btY;

  // create offscreen canvas for each
  const make = (sx,sy,sw,sh)=>{
    const oc=document.createElement('canvas');
    oc.width=Math.floor(sw*(preset.scale||1.8));
    oc.height=Math.floor(sh*(preset.scale||1.8));
    const octx=oc.getContext('2d');
    // basic preprocess: scale + contrast
    octx.drawImage(img, sx, sy, sw, sh, 0,0, oc.width, oc.height);
    // contrast tweak
    const imageData=octx.getImageData(0,0,oc.width,oc.height);
    const data=imageData.data;
    const c = preset.contrast ?? 1.12;
    for(let i=0;i<data.length;i+=4){
      // simple contrast around mid
      for(let k=0;k<3;k++){
        let v = data[i+k];
        v = (v-128)*c + 128;
        data[i+k] = Math.max(0, Math.min(255, v));
      }
    }
    octx.putImageData(imageData,0,0);
    return oc;
  };

  const trimmed = {sx:0, sy:y0, sw:W, sh:Htrim};
  const db = {sx:0, sy:dbY, sw:W, sh:dbH};
  const bt = {sx:0, sy:btY, sw:W, sh:btH};

  return {trimmed, db, bt, make};
}

function renderPreview(){
  const item=state.images[state.currentIndex];
  if(!item){ ctx.clearRect(0,0,cv.width,cv.height); return; }
  const img=item.img;

  // show simple preview in canvas with overlays (scaled)
  const maxW=cv.clientWidth || 800;
  const scale=maxW/img.width;
  const w=Math.max(1, Math.floor(img.width*scale));
  const h=Math.max(1, Math.floor(img.height*scale));
  fitCanvas(w,h);
  ctx.clearRect(0,0,w,h);
  ctx.drawImage(img,0,0,w,h);

  // overlay zones using default preset P0
  const preset=state.presets[0];
  const zones=getZones(img, preset);
  const toScreen=(r)=>({
    x: Math.floor(r.sx*scale),
    y: Math.floor(r.sy*scale),
    w: Math.floor(r.sw*scale),
    h: Math.floor(r.sh*scale),
  });

  ctx.save();
  ctx.lineWidth=2;
  if(state.tab==='all'){
    const db=toScreen(zones.db);
    const bt=toScreen(zones.bt);
    ctx.strokeStyle='rgba(100,210,255,.85)';
    ctx.strokeRect(db.x, db.y, db.w, db.h);
    ctx.fillStyle='rgba(100,210,255,.12)';
    ctx.fillRect(db.x, db.y, db.w, db.h);
    ctx.fillStyle='rgba(100,210,255,.9)';
    ctx.font='12px system-ui';
    ctx.fillText('DB-zone', db.x+8, db.y+18);

    ctx.strokeStyle='rgba(255,214,10,.85)';
    ctx.strokeRect(bt.x, bt.y, bt.w, bt.h);
    ctx.fillStyle='rgba(255,214,10,.10)';
    ctx.fillRect(bt.x, bt.y, bt.w, bt.h);
    ctx.fillStyle='rgba(255,214,10,.95)';
    ctx.fillText('BOTTOM-zone (G6/G7)', bt.x+8, bt.y+18);
  }else if(state.tab==='db'){
    const r=toScreen(zones.db);
    ctx.strokeStyle='rgba(100,210,255,.95)';
    ctx.strokeRect(r.x, r.y, r.w, r.h);
    ctx.fillStyle='rgba(100,210,255,.12)';
    ctx.fillRect(r.x, r.y, r.w, r.h);
  }else{
    const r=toScreen(zones.bt);
    ctx.strokeStyle='rgba(255,214,10,.95)';
    ctx.strokeRect(r.x, r.y, r.w, r.h);
    ctx.fillStyle='rgba(255,214,10,.10)';
    ctx.fillRect(r.x, r.y, r.w, r.h);
  }
  ctx.restore();
}

// ===== OCR / Gate / Vote
function normalizeText(t){
  return (t||'')
    .replace(/[‚Äú‚Äù"]/g,'"')
    .replace(/[|]/g,' ')
    .replace(/\s+/g,' ')
    .trim();
}

function extractNumbers(t){
  // keep digits and spaces
  const s = (t||'').replace(/[^\d\s]/g,' ').replace(/\s+/g,' ').trim();
  if(!s) return [];
  return s.split(' ').filter(Boolean);
}

function gateParse(dbText, btText){
  const dbNums = extractNumbers(dbText);
  const btNums = extractNumbers(btText);

  // DB: find a 5-digit number somewhere, take last 2 digits
  let db2=null, db5=null;
  for(const n of dbNums){
    if(n.length===5){
      db5=n;
      db2=n.slice(-2);
      break;
    }
  }
  // G7: need 4 two-digit numbers. Prefer from btText; take the last line-like sequence near end:
  const g7Candidates = btNums.filter(n=>n.length===2);
  let g7 = null;
  if(g7Candidates.length>=4){
    // pick last 4 two-digit numbers (often at end)
    g7 = g7Candidates.slice(-4);
  }
  // G6: need 3 three-digit numbers
  const g6Candidates = btNums.filter(n=>n.length===3);
  let g6=null;
  if(g6Candidates.length>=3){
    // pick last 3 three-digit numbers (often right above G7)
    g6 = g6Candidates.slice(-3);
  }

  const errs=[];
  if(!db2) errs.push('MISS_DB');
  if(!g7) errs.push('MISS_G7');
  if(!g6) errs.push('MISS_G6');

  // Extra sanity: reject obvious contamination by G4/G5 (many 4-digit tokens)
  const four = btNums.filter(n=>n.length===4).length;
  const contamination = four>=6; // heuristic
  if(contamination) errs.push('NOISY_BOTTOM');

  return {ok: errs.length===0, errs, db2, db5, g7, g6, meta:{fourCount:four} };
}

function scoreGate(g){
  // higher is better
  let s=0;
  if(g.db2) s+=25;
  if(g.g7 && g.g7.length===4) s+=30;
  if(g.g6 && g.g6.length===3) s+=25;
  if(g.meta?.fourCount>=6) s-=18; // noisy bottom
  // prefer distinct g7
  if(g.g7){
    const uniq=new Set(g.g7).size;
    if(uniq===4) s+=6;
  }
  return s;
}

async function ocrCanvas(canvas, psm=6){
  const worker = await Tesseract.createWorker('eng', 1, {
    logger: m => {
      // keep quiet; could log progress if needed
    }
  });
  await worker.setParameters({
    tessedit_pageseg_mode: String(psm),
    // whitelist digits and basic letters (VE/DB lines)
    tessedit_char_whitelist: '0123456789VEveDBdbƒêƒë '
  });
  const { data } = await worker.recognize(canvas);
  await worker.terminate();
  return { text: normalizeText(data.text), conf: data.confidence ?? 0 };
}

async function runOnePreset(img, preset){
  const zones = getZones(img, preset);
  const dbCv = zones.make(zones.db.sx, zones.db.sy, zones.db.sw, zones.db.sh);
  const btCv = zones.make(zones.bt.sx, zones.bt.sy, zones.bt.sw, zones.bt.sh);

  // OCR 2 zone with slightly different psm
  const [dbRes, btRes] = await Promise.all([
    ocrCanvas(dbCv, 6),
    ocrCanvas(btCv, 6),
  ]);

  const gate = gateParse(dbRes.text, btRes.text);
  const score = scoreGate(gate) + (dbRes.conf + btRes.conf) * 0.10; // add mild conf
  return {
    preset: preset.name,
    dbText: dbRes.text, btText: btRes.text,
    conf: {db: dbRes.conf, bt: btRes.conf},
    gate, score
  };
}

async function runVote(img, passes=6){
  const results=[];
  for(let i=0;i<Math.min(passes, state.presets.length);i++){
    const preset=state.presets[i];
    try{
      results.push(await runOnePreset(img, preset));
    }catch(e){
      results.push({preset:preset.name, error:String(e), score:-999, gate:{ok:false, errs:['OCR_ERR']}});
    }
  }
  results.sort((a,b)=>b.score-a.score);
  return {winner:results[0], all:results};
}

// ===== Timeline commit/quarantine
function computeNextDay(){
  const sd=parseDateISO($('startDate').value.trim());
  if(!sd) return null;
  const store=loadStore();
  // next day = startDate + store.length
  return addDays(sd, store.length);
}

function commitDay(entry){
  const store=loadStore();
  // enforce unique day: overwrite if same day exists
  const idx = store.findIndex(x=>x.day===entry.day);
  if(idx>=0) store[idx]=entry; else store.push(entry);
  // sort by day
  store.sort((a,b)=>a.day.localeCompare(b.day));
  saveStore(store);
}

function quarantineAdd(item){
  const q=loadQuar();
  q.unshift(item);
  // keep last 50
  saveQuar(q.slice(0,50));
}

// ===== PHA SAFE + SOI engine (ƒë·ªß d√πng + ƒë√∫ng y√™u c·∫ßu format)
function getCoreDigits(last){
  // l√µi = (ƒëu√¥i ƒêB + l√µi G7)  (theo y√™u c·∫ßu c·ªßa H√†o)
  // Implement: core digits = last.db2 last digit + all last digits of g7 numbers
  const core=new Set();
  if(last?.db2) core.add(last.db2[1]);
  if(last?.g7){
    last.g7.forEach(x=> core.add(String(x).slice(-1)));
  }
  return [...core].sort();
}

function isBienHeavy(day){
  // ‚Äúbi√™n‚Äù = 0/9 xu·∫•t hi·ªán nhi·ªÅu ·ªü DB2/G7
  const s = (day.db2||'') + ' ' + (day.g7||[]).join(' ');
  const zeros = (s.match(/0/g)||[]).length;
  const nines = (s.match(/9/g)||[]).length;
  return (zeros+nines)>=3;
}

function noiseScore(days){
  // heuristic: nhi·ªÅu t·ªïng (sum last digits) tr√πng + bi√™n n·∫∑ng => nhi·ªÖu
  let n=0;
  const sums=[];
  for(const d of days){
    if(!d.db2) continue;
    const a=Number(d.db2[0]), b=Number(d.db2[1]);
    sums.push((a+b)%10);
  }
  const uniq=new Set(sums).size;
  if(uniq<=Math.max(1, Math.floor(sums.length/2))) n+=2;
  if(days.some(isBienHeavy)) n+=2;
  return n; // 0..4
}

function detectPha(days){
  // ultra simple pha detector: d·ª±a tr√™n bi√™n + ƒë·ªô l·∫∑p l√µi
  // Output: "M·ªû|CH·∫†Y|ƒê·∫¢O|X·∫¢|STOP"
  if(days.length<3) return {pha:'STOP', conf:25, note:'Thi·∫øu d·ªØ li·ªáu s·∫°ch (c·∫ßn ‚â• 3 ng√†y commit).'};
  const last=days[days.length-1];
  const core=getCoreDigits(last);
  const bien=isBienHeavy(last);

  // core strength: how many last-2 days share core digits in g7 last digits
  let coreHit=0;
  for(const d of days.slice(-3)){
    const cd=new Set(getCoreDigits(d));
    const inter=core.filter(x=>cd.has(x)).length;
    if(inter>=2) coreHit++;
  }

  let pha='CH·∫†Y';
  let conf=55;
  let note='Chu·ªói s·∫°ch.';

  const n=noiseScore(days);
  if(n>=4){
    pha='X·∫¢';
    conf=48;
    note='T·ªïng nhi·ªÖu cao (bi√™n/t·ªïng).';
  }else if(bien && coreHit<=1){
    pha='STOP';
    conf=35;
    note='Bi√™n + thi·∫øu l√µi ‚Üí d·ªÖ b·∫´y.';
  }else if(coreHit>=3 && !bien){
    pha='CH·∫†Y';
    conf=62;
    note='L√µi d√≠nh ƒë·ªÅu ‚Üí c√≤n nh·ªãp.';
  }else if(coreHit>=2 && bien){
    pha='ƒê·∫¢O';
    conf=55;
    note='C√≥ l√µi nh∆∞ng bi√™n chen ‚Üí d·ªÖ ƒë·∫£o nh·ªãp.';
  }else{
    pha='M·ªû';
    conf=52;
    note='D·ªØ li·ªáu ·ªïn nh∆∞ng l√µi ch∆∞a ch·∫∑t.';
  }
  return {pha, conf, note, core, noise:n};
}

function b√≥ng(n2){
  // b√≥ng = 9-x (2 s·ªë)
  const a=Number(n2[0]), b=Number(n2[1]);
  return `${9-a}${9-b}`;
}
function ƒë·∫£o(n2){ return `${n2[1]}${n2[0]}`; }

function buildScenarios(days){
  const last=days[days.length-1];
  const core=getCoreDigits(last);
  const corePick = core.length? core[core.length-1] : last?.db2?.[1] || '0';

  // TH1: H·ªìi l√µi -> XY v·ªõi Y=corePick (∆∞u ti√™n gi·ªØ ƒëu√¥i)
  const th1 = `${last.db2[0]}${corePick}`;

  // TH2: ƒê·∫£o 1 nh·ªãp quanh l√µi -> ƒë·∫£o DB2
  const th2 = ƒë·∫£o(last.db2);

  // TH3: Bung/ƒë√°nh l·∫°c -> b√≥ng DB2 (anti)
  const th3 = b√≥ng(last.db2);

  // Anti-b·∫´y: ∆∞u ti√™n anti theo "b√≥ng" ho·∫∑c "bi√™n" t√πy pha
  const anti = th3; // default anti = b√≥ng

  // Rank heuristic: n·∫øu pha CH·∫†Y => ∆∞u ti√™n TH1/TH2; n·∫øu X·∫¢/STOP => ∆∞u ti√™n anti
  return { core, th1, th2, th3, anti };
}

function chot6Lines(days){
  const phaInfo=detectPha(days);
  const last=days[days.length-1];
  const {th1,th2,th3,anti,core}=buildScenarios(days);

  let huong='Gi·∫£m l·ª±c, n√© bi√™n, ∆∞u ti√™n anti';
  let vai='G6/G7 ch∆∞a l·ªô r√µ';
  let decision='D·ª™NG';
  let chot='--';
  let antiPick=anti;

  if(phaInfo.pha==='CH·∫†Y'){
    huong='B√°m l√µi, ∆∞u ti√™n h·ªìi l√µi / ƒë·∫£o nh·∫π';
    vai='G7 d√≠nh l√µi + G6 c√≤n neo = c√≤n nh·ªãp';
    decision='CH∆†I NH·∫∏';
    chot = th1;
  }else if(phaInfo.pha==='ƒê·∫¢O'){
    huong='ƒê·∫£o nh·ªãp, ch·ªët theo TH2 + k√®m anti';
    vai='G7 c√≥ l√µi nh∆∞ng bi√™n chen ‚Üí ƒë·ªÅ ph√≤ng ƒë·∫£o';
    decision='CH∆†I NH·∫∏';
    chot = th2;
  }else if(phaInfo.pha==='M·ªû'){
    huong='ThƒÉm d√≤, ∆∞u ti√™n TH1; thi·∫øu l√µi th√¨ d·ª´ng';
    vai='G6/G7 m·ªõi m·ªü, ch∆∞a kh√≥a tr·ª•c';
    decision='CH∆†I R·∫§T NH·∫∏ / HO·∫∂C D·ª™NG';
    chot = th1;
  }else if(phaInfo.pha==='X·∫¢'){
    huong='X·∫£/nhi·ªÖu: n√© bi√™n, ∆∞u ti√™n anti, kh√¥ng √©p tr·ª•c';
    vai='G6/G7 nhi·ªÖu, d·ªÖ k√©o sai nh·ªãp';
    decision='CH∆†I ANTI / HO·∫∂C D·ª™NG';
    chot = th3; // anti as ‚Äúch·ªët‚Äù
  }else{
    huong='STOP theo PHA SAFE (thi·∫øu l√µi/bi√™n/nhi·ªÖu)';
    vai='Kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán kh√≥a pha';
    decision='STOP';
    chot = '--';
  }

  // If STOP, force anti only
  if(phaInfo.pha==='STOP'){
    antiPick = b√≥ng(last.db2);
  }

  // 6 lines strict
  const lines = [
    `1) PHA ng√†y: ${phaInfo.pha}`,
    `2) H∆∞·ªõng ch√≠nh: ${huong}`,
    `3) Vai tr√≤ G6‚ÄìG7: ${vai}`,
    `4) TH c·ª• th·ªÉ: TH1(H·ªìi l√µi‚Üí${th1}) | TH2(ƒê·∫£o nh·ªãp‚Üí${th2}) | TH3(Bung/anti‚Üí${th3})`,
    `5) Ch·ªët 1 c·∫∑p: ${chot}`,
    `6) Anti-b·∫´y: ${antiPick} | Quy·∫øt ƒë·ªãnh: ${decision} | Tin c·∫≠y‚âà${Math.round(phaInfo.conf)}%`
  ];
  return {lines, phaInfo};
}

// ===== UI render
function renderLists(){
  const store=loadStore();
  const q=loadQuar();
  $('kDays').textContent=String(store.length);
  $('savedList').textContent = store.length
    ? store.map(x=>`${x.day} | DB=${x.db2} | G7=${x.g7.join(' ')} | G6=${x.g6.join(' ')}`).join('\n')
    : '‚Äî';

  $('quarantineList').textContent = q.length
    ? q.map(x=>`[${x.when}] ${x.name||'image'} | errs=${(x.errs||[]).join(',')} | note=${x.note||''}`).join('\n')
    : '‚Äî';
}

function renderChot(){
  const store=loadStore();
  const lastN = store.slice(-5); // analyze last 5 clean days
  if(lastN.length<3){
    $('chot6').textContent='Ch∆∞a ƒë·ªß d·ªØ li·ªáu s·∫°ch (c·∫ßn ‚â• 3 ng√†y commit).';
    $('kConf').textContent='0%';
    return;
  }
  const {lines, phaInfo} = chot6Lines(lastN);
  $('chot6').textContent = lines.join('\n');
  $('kConf').textContent = `${Math.round(phaInfo.conf)}%`;
}

function renderKPI(){
  $('kOK').textContent=String(state.ok);
  $('kFail').textContent=String(state.fail);
}

// ===== Main run
async function runBatch({rescue=false}={}){
  if(state.running) return;
  state.running=true;
  try{
    const sd = parseDateISO($('startDate').value.trim());
    if(!sd){
      toast('StartDate sai ƒë·ªãnh d·∫°ng. VD: 2026-02-28');
      return;
    }
    if(state.images.length===0){
      toast('Ch∆∞a ch·ªçn ·∫£nh.');
      return;
    }

    state.ok=0; state.fail=0; renderKPI();
    $('gateOut').textContent='ƒêang ch·∫°y...';

    // Process sequential to avoid mobile crash
    for(let i=0;i<state.images.length;i++){
      state.currentIndex=i;
      renderPreview();

      const img=state.images[i].img;
      const name=state.images[i].name;

      // Manual fix override (optional)
      const mf = $('manualFix').value.trim();
      let usedManual=false;
      let manualParsed=null;
      if(mf){
        // parse: DB=xx | G7=a b c d | G6=xxx yyy zzz
        const mdb = mf.match(/DB\s*=\s*(\d{2})/i);
        const mg7 = mf.match(/G7\s*=\s*([0-9 ]{8,20})/i);
        const mg6 = mf.match(/G6\s*=\s*([0-9 ]{8,20})/i);
        if(mdb && mg7 && mg6){
          const g7 = mg7[1].trim().split(/\s+/).filter(x=>/^\d{2}$/.test(x)).slice(0,4);
          const g6 = mg6[1].trim().split(/\s+/).filter(x=>/^\d{3}$/.test(x)).slice(0,3);
          if(g7.length===4 && g6.length===3){
            manualParsed = { ok:true, errs:[], db2:mdb[1], g7, g6 };
            usedManual=true;
          }
        }
      }

      let winner=null;

      if(usedManual){
        winner = {
          preset:'MANUAL',
          dbText:'(manual)', btText:'(manual)',
          conf:{db:100, bt:100},
          gate:manualParsed,
          score:999
        };
      }else{
        // vote: normal pass = 4, rescue pass = 6
        const vote = await runVote(img, rescue ? 6 : 4);
        winner = vote.winner;
      }

      // show raw winner OCR
      $('ocrDB').value = winner.dbText || '';
      $('ocrBT').value = winner.btText || '';

      // Gate final
      const g = winner.gate;
      const nextDay = computeNextDay();
      const day = nextDay ? fmtDate(nextDay) : null;

      if(g.ok && day){
        // commit
        commitDay({
          day,
          db2: g.db2,
          g7: g.g7,
          g6: g.g6,
          via: usedManual ? 'MANUAL' : `OCR:${winner.preset}`,
          ts: Date.now(),
          src: name
        });
        state.ok++;
        $('gateOut').textContent =
          `GATE: OK  (${usedManual ? 'via=MANUAL' : 'via=OCR'})\n`+
          `day=${day}\n`+
          `DB=${g.db2} | G7=${g.g7.join(' ')} | G6=${g.g6.join(' ')}\n`+
          `preset=${winner.preset} score=${Math.round(winner.score)} conf(db/bt)=${Math.round(winner.conf.db)}/${Math.round(winner.conf.bt)}\n`+
          `Commit: OK (dayPointer++)`;
      }else{
        // quarantine
        state.fail++;
        quarantineAdd({
          when: new Date().toLocaleString(),
          name,
          errs: g.errs || ['GATE_FAIL'],
          note: usedManual ? 'Manual parse fail' : `bestPreset=${winner.preset} score=${Math.round(winner.score)}`
        });
        $('gateOut').textContent =
          `GATE: FAIL\n`+
          `errs=${(g.errs||[]).join(',')}\n`+
          `${usedManual ? 'via=MANUAL' : 'via=OCR'} preset=${winner.preset}\n`+
          `Quarantine: ON (kh√¥ng tƒÉng dayPointer)\n`+
          `G·ª£i √Ω: b·∫≠t Rescue / crop s√°t b·∫£ng / ho·∫∑c d√°n Manual Fix.`;
      }

      renderKPI();
      renderLists();
      renderChot();
    }

    toast(`Xong: OK=${state.ok} | FAIL=${state.fail}`);
  } finally{
    state.running=false;
  }
}

// ===== File input
$('files').addEventListener('change', async (e)=>{
  const files=[...e.target.files||[]];
  if(!files.length) return;

  state.images=[];
  for(const f of files){
    const url=URL.createObjectURL(f);
    const img=new Image();
    img.src=url;
    await new Promise(res=>{ img.onload=res; img.onerror=res; });
    state.images.push({file:f, img, name:f.name});
  }
  state.currentIndex=0;
  renderPreview();
  toast(`ƒê√£ n·∫°p ${state.images.length} ·∫£nh`);
});

// ===== Buttons
$('btnRun').addEventListener('click', ()=>runBatch({rescue:false}));
$('btnRescue').addEventListener('click', ()=>runBatch({rescue:true}));

$('btnReset').addEventListener('click', ()=>{
  if(!confirm('RESET S·∫†CH: x√≥a d·ªØ li·ªáu Save + Quarantine?')) return;
  localStorage.removeItem(state.storeKey);
  localStorage.removeItem(state.qKey);
  state.ok=0; state.fail=0;
  renderKPI(); renderLists(); renderChot();
  $('gateOut').textContent='‚Äî';
  $('ocrDB').value=''; $('ocrBT').value='';
  toast('ƒê√£ reset s·∫°ch');
});

$('btnAnalyze').addEventListener('click', ()=>{
  renderChot();
  toast('ƒê√£ c·∫≠p nh·∫≠t SOI & CH·ªêT');
});

$('btnExport').addEventListener('click', ()=>{
  const payload={
    meta:{app:'BH_ULTRA_V4', ts:Date.now()},
    startDate:$('startDate').value.trim(),
    store:loadStore(),
    quarantine:loadQuar()
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`BH_ULTRA_V4_${Date.now()}.json`;
  a.click();
  toast('ƒê√£ export JSON');
});

$('btnImport').addEventListener('click', ()=> $('importFile').click());
$('importFile').addEventListener('change', async (e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{
    const txt=await f.text();
    const j=JSON.parse(txt);
    if(j?.store) saveStore(j.store);
    if(j?.quarantine) saveQuar(j.quarantine);
    if(j?.startDate) $('startDate').value=j.startDate;
    renderLists(); renderChot();
    toast('Import OK');
  }catch(err){
    toast('Import FAIL: file kh√¥ng h·ª£p l·ªá');
  }finally{
    e.target.value='';
  }
});

// ‚ÄúD√°n m·∫´u‚Äù: t·∫°o chu·ªói demo (kh√¥ng c·∫ßn ·∫£nh)
$('btnSample').addEventListener('click', ()=>{
  $('startDate').value = $('startDate').value.trim() || '2026-02-28';
  const sd=parseDateISO($('startDate').value.trim());
  if(!sd){ toast('StartDate sai'); return; }
  const demo=[
    {db2:'81', g7:['75','42','09','81'], g6:['586','074','150']},
    {db2:'13', g7:['91','14','96','09'], g6:['243','887','936']},
    {db2:'12', g7:['30','88','09','33'], g6:['003','214','087']},
    {db2:'74', g7:['45','43','00','57'], g6:['396','332','669']},
    {db2:'37', g7:['95','36','37','42'], g6:['344','904','115']},
  ];
  const store=demo.map((d,i)=>({
    day: fmtDate(addDays(sd,i)),
    ...d, via:'SAMPLE', ts:Date.now()
  }));
  saveStore(store);
  saveQuar([]);
  renderLists(); renderChot();
  toast('ƒê√£ d√°n m·∫´u demo (5 ng√†y s·∫°ch)');
});

// ===== Init
(function init(){
  // set default start date if empty
  const today=new Date();
  const def = fmtDate(new Date(Date.UTC(today.getFullYear(), today.getMonth(), today.getDate())));
  $('startDate').value = $('startDate').value.trim() || def;

  renderLists();
  renderChot();
  renderPreview();
  toast('ULTRA V4 s·∫µn s√†ng');
})();
</script>
</body>
</html>
