<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate PRO ‚Ä¢ PHA SAFE HardLock v4)</title>

  <!-- Tesseract.js (OCR) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- OpenCV.js (preprocess) -->
  <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

  <style>
    :root{
      --bg:#08131f; --card:#0e1f31; --card2:#0b1a2a;
      --txt:#e9f3ff; --muted:#98b0c9; --line:rgba(255,255,255,.08);
      --ok:#29d17e; --warn:#f0b429; --bad:#ff4d4d; --blue:#2a7fff;
      --btn:#163a66;
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:var(--sans); color:var(--txt);
      background: radial-gradient(900px 600px at 20% -10%, rgba(42,127,255,.22), transparent 60%),
                  radial-gradient(800px 500px at 110% 10%, rgba(41,209,126,.18), transparent 55%),
                  linear-gradient(180deg, #050d16 0%, #071423 55%, #050d16 100%);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:22px 14px 40px;}
    .title{
      font-weight:800; font-size:26px; letter-spacing:.2px; line-height:1.15;
      margin:10px 6px 6px;
    }
    .sub{color:var(--muted);margin:0 6px 14px;font-size:14px;line-height:1.35}
    .grid{display:grid;grid-template-columns: 1.15fr .85fr; gap:14px;}
    @media (max-width:900px){ .grid{grid-template-columns:1fr;}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      padding:16px;
      backdrop-filter: blur(10px);
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:8px 12px; border-radius:999px;
      background: rgba(0,0,0,.18);
      border: 1px solid var(--line);
      color: var(--muted);
      font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .btn{
      appearance:none; border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(42,127,255,.22), rgba(22,58,102,.22));
      color:var(--txt);
      padding:12px 14px; border-radius:14px;
      font-weight:700; cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      transition:.15s transform, .15s filter;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background: rgba(0,0,0,.16)}
    .btn.danger{background: linear-gradient(180deg, rgba(255,77,77,.22), rgba(0,0,0,.12));}
    .btn.small{padding:9px 11px;border-radius:12px;font-weight:700;font-size:13px}
    .btn:disabled{opacity:.55;cursor:not-allowed;filter:grayscale(.2)}
    input, textarea{
      width:100%; padding:12px 12px;
      border-radius:14px; border:1px solid var(--line);
      background: rgba(0,0,0,.22); color:var(--txt);
      outline:none;
      font-family: var(--sans);
    }
    textarea{min-height:140px;font-family:var(--mono);font-size:12.5px;line-height:1.35}
    .label{font-size:13px;color:var(--muted);margin:10px 0 6px}
    .hint{font-size:12px;color:var(--muted);margin-top:6px;line-height:1.35}
    .sep{height:1px;background:var(--line);margin:14px 0}
    .kpi{
      display:grid; grid-template-columns: repeat(3, 1fr);
      gap:10px; margin-top:10px;
    }
    @media (max-width:520px){ .kpi{grid-template-columns:1fr}}
    .box{
      border:1px dashed rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px;
    }
    .mono{font-family:var(--mono)}
    .big{font-size:26px;font-weight:900}
    .oktxt{color:var(--ok)} .warntxt{color:var(--warn)} .badtxt{color:var(--bad)}
    .preview{
      width:100%; border-radius:18px; border:1px solid var(--line);
      overflow:hidden; background: rgba(255,255,255,.03);
    }
    canvas, video{width:100%; height:auto; display:block}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:720px){ .two{grid-template-columns:1fr}}
    .log{
      white-space:pre-wrap; font-family:var(--mono); font-size:12.5px; line-height:1.35;
      background: rgba(0,0,0,.22); border:1px solid var(--line);
      border-radius:16px; padding:12px; max-height:280px; overflow:auto;
    }
    .tag{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:12px; color:var(--muted);
      margin-right:8px; margin-top:8px;
    }
    .tag strong{color:var(--txt)}
    .footerNote{color:var(--muted);font-size:12px;line-height:1.35;margin-top:10px}
  </style>
</head>

<body>
<div class="wrap">
  <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER (OCR Gate PRO ‚Ä¢ PHA SAFE <span class="mono">HardLock v4</span>)</div>
  <div class="sub">
    Lu·ªìng cao nh·∫•t: <b>StartDate Hard-Assign</b> ‚Üí Preprocess (trim/scale) ‚Üí OCR 2-pass ‚Üí Gate DB/G7/G6 ‚Üí <b>HardLock chu·ªói ng√†y</b> ‚Üí m·ªõi m·ªü PHA.
    <br/>Nguy√™n t·∫Øc: <b>OCR s·∫°ch ‚Üí Gate ƒë√∫ng ‚Üí m·ªõi soi</b>. Thi·∫øu/kh√¥ng ch·∫Øc ‚Üí <b>STOP</b>.
  </div>

  <div class="grid">
    <!-- LEFT -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="row">
          <span class="pill"><span id="stPre" class="dot warn"></span>Preprocess</span>
          <span class="pill"><span id="stOcr" class="dot warn"></span>OCR</span>
          <span class="pill"><span id="stGate" class="dot warn"></span>Gate</span>
          <span class="pill"><span id="stSafe" class="dot warn"></span>PHA SAFE</span>
        </div>
        <div class="row">
          <button class="btn small secondary" id="btnPaste">D√°n m·∫´u</button>
          <button class="btn small danger" id="btnReset">RESET S·∫†CH</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <button class="btn" id="btnUpload">üì∏ Upload nhi·ªÅu ·∫£nh</button>
        <input id="file" type="file" accept="image/*" multiple style="display:none" />
        <button class="btn secondary" id="btnCam">üé• Camera</button>
        <button class="btn secondary" id="btnStopCam" disabled>‚õî T·∫Øt camera</button>
        <button class="btn" id="btnRun" style="margin-left:auto">‚ö° CH·∫†Y FULL</button>
      </div>

      <div class="kpi">
        <div class="box">
          <div class="label">Batch</div>
          <div class="big mono"><span id="kOk">0</span> <span class="muted">OK</span> | <span id="kFail">0</span> <span class="muted">FAIL</span></div>
          <div class="hint">·∫¢nh ƒë√£ n·∫°p: <span id="kN">0</span></div>
        </div>
        <div class="box">
          <div class="label">Save</div>
          <div class="big mono" id="kSave">empty</div>
          <div class="hint">L∆∞u localStorage (export/import l√†m sau)</div>
        </div>
        <div class="box">
          <div class="label">HardLock</div>
          <div class="big mono" id="kLock">OFF</div>
          <div class="hint">Gate-3: kh√¥ng tr√πng/kh√¥ng nh·∫£y l√πi ng√†y</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="two">
        <div>
          <div class="label">StartDate (b·∫Øt bu·ªôc ‚Äî <span class="mono">YYYY-MM-DD</span>)</div>
          <input id="startDate" placeholder="VD: 2026-02-20" />
          <div class="hint">C·ª©ng nh·∫•t: ng√†y = StartDate + index ·∫£nh. Header OCR ch·ªâ ƒë·ªÉ <b>x√°c nh·∫≠n</b> (kh√¥ng quy·∫øt ƒë·ªãnh).</div>
        </div>
        <div>
          <div class="label">Manual Fix (DB|G7|G6) ‚Äî d√°n khi OCR l·ªách</div>
          <input id="manualFix" placeholder="VD: DB=83 | G7=57 42 39 13 | G6=247 554 108" />
          <div class="hint">Ch·ªâ d√πng khi Gate-1 fail. Kh√¥ng ‚Äúƒëo√°n d·ªØ li·ªáu‚Äù.</div>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row" style="gap:8px">
        <span class="tag"><strong>Rescue presets</strong> t·ª± ch·∫°y 3‚Äì4 m·ª©c trim</span>
        <span class="tag"><strong>Gate-2</strong> DB5‚ÜíDB2 kh·ªõp</span>
        <span class="tag"><strong>Gate-3</strong> l·ªách ng√†y = STOP</span>
      </div>

      <div class="sep"></div>

      <div class="label">Preview (auto-trim b·∫£ng)</div>
      <div class="preview">
        <canvas id="cv" width="900" height="1200"></canvas>
        <video id="video" playsinline muted style="display:none"></video>
      </div>

      <div class="footerNote">
        M·∫πo ·∫£nh: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab & header qu·∫£ng c√°o.
        N·∫øu ·∫£nh d√≠nh nhi·ªÅu th·ª© ‚Üí rescue v·∫´n fail ‚Üí d√πng Manual Fix.
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <div class="label">OCR Raw (pass1)</div>
      <textarea id="ocrRaw" placeholder="OCR raw s·∫Ω hi·ªán ·ªü ƒë√¢y..."></textarea>

      <div class="label">Gate Output (pass2)</div>
      <div class="log" id="gateOut">GATE: waiting</div>

      <div class="sep"></div>

      <div class="label">PHA SAFE ‚Ä¢ HardLock</div>
      <div class="box">
        <div class="hint">
          Nguy√™n t·∫Øc: <b>OCR s·∫°ch ‚Üí Gate ƒë√∫ng ‚Üí m·ªõi m·ªü PHA</b>. N·∫øu thi·∫øu/kh√¥ng ch·∫Øc ‚Üí <b>STOP</b>.
        </div>
        <div class="sep"></div>
        <div class="hint mono" id="chainPreview">(ch∆∞a c√≥ d·ªØ li·ªáu)</div>
        <div class="sep"></div>
        <div class="hint mono" id="phaResult">PHA: STOP<br/>Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch).<br/>Confidence‚âà25%</div>
      </div>

      <div class="sep"></div>

      <div class="label">Checklist ch·ªëng l·ªách ng√†y / l·ªách pha</div>
      <div class="hint">
        ‚Ä¢ Ng√†y ph·∫£i tƒÉng ƒë√∫ng th·ª© t·ª± (kh√¥ng tr√πng, kh√¥ng nh·∫£y l√πi).<br/>
        ‚Ä¢ M·ªói ng√†y: ph·∫£i c√≥ <b>DB2</b> + <b>G7(4 s·ªë)</b> + <b>G6(3 s·ªë)</b>.<br/>
        ‚Ä¢ Gate fail ‚Üí d√πng Manual Fix, kh√¥ng ‚Äúƒëo√°n d·ªØ li·ªáu‚Äù.<br/>
        ‚Ä¢ Gate-3 fail ‚Üí <b>STOP</b>, kh√¥ng soi pha.
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   HARDLOCK v4 ‚Äî One-file PWA-style HTML
   - StartDate hard-assign (c·ª©ng nh·∫•t)
   - Two-pass OCR: table OCR is main; header OCR optional (future)
   - Rescue presets: try multiple trims automatically
   - Gate 1/2/3: format / consistency / order
   ========================= */

const $ = (id)=>document.getElementById(id);

const st = {
  pre: $("stPre"), ocr:$("stOcr"), gate:$("stGate"), safe:$("stSafe")
};
function setDot(dot, state){ // ok|warn|bad
  dot.classList.remove("ok","warn","bad");
  dot.classList.add(state);
}
function logGate(s){ $("gateOut").textContent = s; }
function setRaw(s){ $("ocrRaw").value = s || ""; }

const cv = $("cv");
const ctx = cv.getContext("2d");
const video = $("video");
let camStream = null;

let images = []; // {name, img, w,h}
let lastRun = null;

const LS_KEY = "BH_ULTRA_HARDLOCK_V4_CHAIN";
function loadSaved(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(!Array.isArray(arr)) return [];
    return arr;
  }catch(e){ return []; }
}
function saveChain(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
  $("kSave").textContent = arr.length ? (arr.length + " ng√†y") : "empty";
}
function clearAll(){
  images = [];
  setRaw("");
  logGate("GATE: waiting");
  $("kOk").textContent = "0";
  $("kFail").textContent = "0";
  $("kN").textContent = "0";
  $("kLock").textContent = "OFF";
  $("chainPreview").textContent = "(ch∆∞a c√≥ d·ªØ li·ªáu)";
  $("phaResult").innerHTML = "PHA: STOP<br/>Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch).<br/>Confidence‚âà25%";
  saveChain([]);
  setDot(st.pre,"warn"); setDot(st.ocr,"warn"); setDot(st.gate,"warn"); setDot(st.safe,"warn");
  drawEmpty();
}
function drawEmpty(){
  ctx.clearRect(0,0,cv.width,cv.height);
  ctx.fillStyle = "rgba(255,255,255,.06)";
  ctx.fillRect(0,0,cv.width,cv.height);
  ctx.fillStyle = "rgba(255,255,255,.55)";
  ctx.font = "24px ui-monospace, monospace";
  ctx.fillText("Preview", 26, 46);
}

function todayISO(){
  const d = new Date();
  const z = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function addDaysISO(iso, add){
  const [y,m,dd] = iso.split("-").map(Number);
  const d = new Date(y, m-1, dd);
  d.setDate(d.getDate()+add);
  const z = (n)=>String(n).padStart(2,"0");
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function isISODate(s){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(s)) return false;
  const [y,m,d] = s.split("-").map(Number);
  const dt = new Date(y,m-1,d);
  return dt.getFullYear()===y && (dt.getMonth()+1)===m && dt.getDate()===d;
}

/* ---------- Upload / Camera ---------- */
$("btnUpload").onclick = ()=> $("file").click();
$("file").addEventListener("change", async (e)=>{
  const files = Array.from(e.target.files || []);
  if(!files.length) return;
  await loadFiles(files);
});

$("btnCam").onclick = async ()=>{
  try{
    camStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
    video.srcObject = camStream;
    video.style.display = "block";
    await video.play();
    $("btnStopCam").disabled = false;
    // Tap to capture
    video.onclick = ()=>captureFrame();
  }catch(err){
    alert("Kh√¥ng m·ªü ƒë∆∞·ª£c camera: " + err.message);
  }
};
$("btnStopCam").onclick = ()=>{
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream = null;
  }
  video.pause();
  video.style.display = "none";
  $("btnStopCam").disabled = true;
};

async function captureFrame(){
  if(!video.videoWidth) return;
  const tcv = document.createElement("canvas");
  tcv.width = video.videoWidth;
  tcv.height = video.videoHeight;
  tcv.getContext("2d").drawImage(video,0,0);
  const blob = await new Promise(res=>tcv.toBlob(res,"image/jpeg",0.92));
  const file = new File([blob], "camera_"+Date.now()+".jpg", {type:"image/jpeg"});
  await loadFiles([file]);
}

async function loadFiles(files){
  const added = [];
  for(const f of files){
    const img = await fileToImage(f);
    added.push({name:f.name, img, w:img.naturalWidth, h:img.naturalHeight});
  }
  images.push(...added);
  $("kN").textContent = String(images.length);
  // show first preview trimmed
  previewImage(0);
}
function fileToImage(file){
  return new Promise((resolve,reject)=>{
    const url = URL.createObjectURL(file);
    const img = new Image();
    img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(new Error("Load image fail")); };
    img.src = url;
  });
}

function previewImage(idx){
  if(!images[idx]) return drawEmpty();
  const {img} = images[idx];
  // Default preview: show "table trim preset #1"
  const preset = PRESETS[0];
  const out = basicTrimScale(img, preset.trimTop, preset.trimBot, preset.scale);
  ctx.clearRect(0,0,cv.width,cv.height);
  // fit to canvas
  const r = Math.min(cv.width/out.width, cv.height/out.height);
  const w = out.width*r, h = out.height*r;
  ctx.drawImage(out, (cv.width-w)/2, (cv.height-h)/2, w, h);
}

/* ---------- Preprocess (fallback) ---------- */
function basicTrimScale(img, trimTopPct, trimBotPct, scale){
  // Trim only vertical, keep full width
  const w = img.naturalWidth, h = img.naturalHeight;
  const top = Math.floor(h * trimTopPct);
  const bot = Math.floor(h * trimBotPct);
  const th = Math.max(1, h - top - bot);

  const c = document.createElement("canvas");
  c.width = Math.floor(w*scale);
  c.height = Math.floor(th*scale);
  const cctx = c.getContext("2d");
  // sharpen-ish: just draw scaled
  cctx.drawImage(img, 0, top, w, th, 0, 0, c.width, c.height);
  // simple contrast boost
  const id = cctx.getImageData(0,0,c.width,c.height);
  const data = id.data;
  const contrast = 1.18; // mild
  const bias = -12;
  for(let i=0;i<data.length;i+=4){
    let r = data[i], g=data[i+1], b=data[i+2];
    r = Math.min(255, Math.max(0, r*contrast + bias));
    g = Math.min(255, Math.max(0, g*contrast + bias));
    b = Math.min(255, Math.max(0, b*contrast + bias));
    data[i]=r; data[i+1]=g; data[i+2]=b;
  }
  cctx.putImageData(id,0,0);
  return c;
}

/* ---------- Rescue presets (auto) ---------- */
const PRESETS = [
  {name:"P1", trimTop:0.14, trimBot:0.12, scale:1.55},
  {name:"P2", trimTop:0.10, trimBot:0.10, scale:1.55},
  {name:"P3", trimTop:0.18, trimBot:0.10, scale:1.70},
  {name:"P4", trimTop:0.12, trimBot:0.16, scale:1.70},
];

/* ---------- OCR ---------- */
async function ocrCanvas(canvas){
  const worker = await Tesseract.createWorker("eng");
  // We want digits; but labels are Vietnamese‚Äîstill ok, we care numbers.
  await worker.setParameters({
    tessedit_char_whitelist: "0123456789DBƒêBGG/:- ",
    preserve_interword_spaces: "1"
  });
  const { data } = await worker.recognize(canvas);
  await worker.terminate();
  return (data && data.text) ? data.text : "";
}

/* ---------- Parse helpers ---------- */
function normText(t){
  return (t||"")
    .replace(/\r/g,"\n")
    .replace(/[^\S\n]+/g," ")
    .replace(/[|]/g," ")
    .replace(/[‚Äò‚Äô]/g,"'")
    .replace(/[‚Äú‚Äù]/g,'"')
    .replace(/[^\x00-\x7Fƒêƒë]/g," "); // keep ƒê ƒë
}
function extractDB5(text){
  // Prefer pattern: "ƒêB" or "DB" then 5 digits somewhere after
  const t = text;
  // common OCR: "DB 36481" or "08 36481" after label
  let m = t.match(/(?:\bƒêB\b|\bDB\b)\s*[:\-]?\s*([0-9]{5})/i);
  if(m) return m[1];
  // fallback: find any 5-digit number near top lines
  const lines = t.split("\n").map(s=>s.trim()).filter(Boolean).slice(0,12);
  for(const ln of lines){
    const mm = ln.match(/\b([0-9]{5})\b/);
    if(mm) return mm[1];
  }
  return null;
}
function extractG7(text){
  // Find a line containing exactly 4 two-digit numbers
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
  // Prefer last third lines
  const start = Math.max(0, lines.length - 10);
  const cand = lines.slice(start).concat(lines); // give priority to bottom
  for(const ln of cand){
    const nums = ln.match(/\b\d{2}\b/g);
    if(nums && nums.length === 4) return nums.slice(0,4);
  }
  // fallback: pick any 4 two-digit tokens near bottom
  const all = (text.match(/\b\d{2}\b/g) || []);
  if(all.length >= 4) return all.slice(-4);
  return null;
}
function extractG6(text){
  // Find a line containing exactly 3 three-digit numbers
  const lines = text.split("\n").map(s=>s.trim()).filter(Boolean);
  const start = Math.max(0, lines.length - 14);
  const cand = lines.slice(start).concat(lines);
  for(const ln of cand){
    const nums = ln.match(/\b\d{3}\b/g);
    if(nums && nums.length === 3) return nums.slice(0,3);
  }
  // fallback: pick last 3 three-digit tokens
  const all = (text.match(/\b\d{3}\b/g) || []);
  if(all.length >= 3) return all.slice(-3);
  return null;
}
function scoreParse({db5, g7, g6}){
  let s=0;
  if(db5) s+=45;
  if(g7 && g7.length===4) s+=30;
  if(g6 && g6.length===3) s+=25;
  return s;
}

/* ---------- Manual fix parse ---------- */
function parseManualFix(s){
  if(!s) return null;
  // DB=83 | G7=57 42 39 13 | G6=247 554 108
  const out = {};
  const dbm = s.match(/DB\s*=\s*(\d{2})/i);
  if(dbm) out.db2 = dbm[1];
  const g7m = s.match(/G7\s*=\s*([0-9 ]{8,})/i);
  if(g7m){
    const nums = g7m[1].match(/\b\d{2}\b/g);
    if(nums && nums.length>=4) out.g7 = nums.slice(0,4);
  }
  const g6m = s.match(/G6\s*=\s*([0-9 ]{8,})/i);
  if(g6m){
    const nums = g6m[1].match(/\b\d{3}\b/g);
    if(nums && nums.length>=3) out.g6 = nums.slice(0,3);
  }
  if(out.db2 || out.g7 || out.g6) return out;
  return null;
}

/* ---------- Gates ---------- */
function gate1_format(parsed){
  const errs=[];
  if(!parsed.date || !isISODate(parsed.date)) errs.push("BAD_DATE");
  if(!parsed.db2 || !/^\d{2}$/.test(parsed.db2)) errs.push("MISS_DB2");
  if(!parsed.g7 || parsed.g7.length!==4 || parsed.g7.some(x=>!/^\d{2}$/.test(x))) errs.push("MISS_G7");
  if(!parsed.g6 || parsed.g6.length!==3 || parsed.g6.some(x=>!/^\d{3}$/.test(x))) errs.push("MISS_G6");
  return errs;
}
function gate2_consistency(parsed){
  // If db5 exists, last2 must match db2
  const errs=[];
  if(parsed.db5 && parsed.db2){
    const last2 = parsed.db5.slice(-2);
    if(last2 !== parsed.db2) errs.push("DB5_MISMATCH_DB2");
  }
  return errs;
}
function gate3_order(chain){
  // strict increasing unique dates
  const errs=[];
  const dates = chain.map(x=>x.date);
  const set = new Set(dates);
  if(set.size !== dates.length) errs.push("DUP_DATE");
  for(let i=1;i<dates.length;i++){
    if(dates[i] <= dates[i-1]){ errs.push("NON_INCREASING"); break; }
  }
  return errs;
}

/* ---------- PHA SAFE (stub) ----------
   B·∫°n ƒëang mu·ªën "pha safe" si√™u c·ª©ng.
   ·ªû b·∫£n n√†y: ch·ªâ m·ªü khi >=3 ng√†y s·∫°ch + Gate3 ok.
   (Ph·∫ßn ƒë·ªçc pha chi ti·∫øt b·∫°n g·∫Øn module sau: M1/M2/M3 + auto-hint)
*/
function phaSafe(chain){
  if(chain.length < 3){
    return {pha:"STOP", conf:25, note:"Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch)."};
  }
  // Simple placeholder logic: detect recent DB2 movement & note only.
  const last = chain[chain.length-1].db2;
  const prev = chain[chain.length-2].db2;
  const hint = (last[1]===prev[1]) ? "ƒêu√¥i gi·ªØ nh·ªãp" : "ƒêu√¥i ƒë·ªïi nh·ªãp";
  return {pha:"OK", conf:55, note:`Chu·ªói s·∫°ch. ${hint}. (Module pha chi ti·∫øt g·∫Øn sau)`};
}

/* ---------- RUN FULL ---------- */
$("btnRun").onclick = async ()=>{
  const sd = $("startDate").value.trim() || "";
  if(!isISODate(sd)){
    alert("StartDate b·∫Øt bu·ªôc ƒë√∫ng format YYYY-MM-DD (VD: 2026-02-20).");
    return;
  }
  if(!images.length){
    alert("Ch∆∞a c√≥ ·∫£nh. H√£y Upload ho·∫∑c Camera r·ªìi ch·ª•p (tap v√†o video ƒë·ªÉ capture).");
    return;
  }

  setDot(st.pre,"warn"); setDot(st.ocr,"warn"); setDot(st.gate,"warn"); setDot(st.safe,"warn");
  $("kOk").textContent = "0"; $("kFail").textContent = "0";
  $("kLock").textContent = "RUN";
  logGate("GATE: running...");
  setRaw("");

  const manual = parseManualFix($("manualFix").value.trim());
  let ok=0, fail=0;
  const chain = [];

  try{
    setDot(st.pre,"ok");

    for(let i=0;i<images.length;i++){
      const date = addDaysISO(sd, i); // HARD ASSIGN
      const img = images[i].img;

      // Try rescue presets and pick best score
      setDot(st.ocr,"warn");
      let best = {score:-1, text:"", parsed:null, preset:null, canvas:null};

      for(const preset of PRESETS){
        const c = basicTrimScale(img, preset.trimTop, preset.trimBot, preset.scale);
        // Show preview current
        ctx.clearRect(0,0,cv.width,cv.height);
        const r = Math.min(cv.width/c.width, cv.height/c.height);
        const w = c.width*r, h = c.height*r;
        ctx.drawImage(c, (cv.width-w)/2, (cv.height-h)/2, w, h);

        const text = normText(await ocrCanvas(c));
        const db5 = extractDB5(text);
        const g7 = extractG7(text);
        const g6 = extractG6(text);
        const parsed = {
          date,
          db5: db5 || null,
          db2: db5 ? db5.slice(-2) : null,
          g7: g7 || null,
          g6: g6 || null,
          src: {name: images[i].name, preset: preset.name}
        };
        const sc = scoreParse({db5, g7, g6});
        if(sc > best.score){
          best = {score:sc, text, parsed, preset, canvas:c};
        }
        // Early break if perfect
        if(sc >= 100) break;
      }

      setRaw(best.text);

      // Apply manual fix only if needed (Gate1 fail)
      let parsed = best.parsed;

      // If OCR missed core fields and manual provided, patch:
      if(manual){
        if(!parsed.db2 && manual.db2) parsed.db2 = manual.db2;
        if(!parsed.g7 && manual.g7) parsed.g7 = manual.g7;
        if(!parsed.g6 && manual.g6) parsed.g6 = manual.g6;
      }

      // Gate 1/2
      const e1 = gate1_format(parsed);
      const e2 = gate2_consistency(parsed);

      if(e1.length || e2.length){
        fail++;
        logGate(
`GATE: FAIL
file=${images[i].name}
date=${date}
preset=${best.preset ? best.preset.name : "?"}
errs=${[...e1,...e2].join(",")}

Tip: ch·ªânh ·∫£nh (crop s√°t b·∫£ng) ho·∫∑c ƒëi·ªÅn Manual Fix (DB|G7|G6).`
        );
        continue;
      }

      ok++;
      chain.push({
        date: parsed.date,
        db2: parsed.db2,
        g7: parsed.g7,
        g6: parsed.g6,
        meta: parsed.src
      });
    }

    setDot(st.ocr, ok ? "ok" : "bad");
    setDot(st.gate, (ok && !fail) ? "ok" : (ok ? "warn" : "bad"));

    // Gate 3 (ORDER)
    const e3 = gate3_order(chain);
    if(e3.length){
      $("kLock").textContent = "STOP";
      setDot(st.safe,"bad");
      logGate(
`GATE-3: HARDLOCK STOP
errs=${e3.join(",")}

L√Ω do: chu·ªói ng√†y b·ªã tr√πng/nh·∫£y l√πi ‚Üí nguy c∆° ƒë·ªçc pha SAI.
Gi·∫£i ph√°p: ƒë·ªïi StartDate ƒë√∫ng + ƒë·∫£m b·∫£o th·ª© t·ª± ·∫£nh ƒë√∫ng ng√†y.`
      );
    }else{
      $("kLock").textContent = "ON";
      setDot(st.safe, chain.length>=3 ? "ok" : "warn");
      logGate(
`GATE: OK
ok=${ok} | fail=${fail}
HardLock=ON
L∆∞u: ch·ªâ m·ªü PHA khi ‚â• 3 ng√†y s·∫°ch.`
      );
    }

    $("kOk").textContent = String(ok);
    $("kFail").textContent = String(fail);

    saveChain(chain);

    // Preview chain
    if(chain.length){
      const tail = chain.slice(-8).map(x=>{
        return `${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`;
      }).join("\n");
      $("chainPreview").textContent = tail;
      const pha = phaSafe(chain);
      $("phaResult").innerHTML = `PHA: ${pha.pha}<br/>${pha.note}<br/>Confidence‚âà${pha.conf}%`;
    }else{
      $("chainPreview").textContent = "(ch∆∞a c√≥ d·ªØ li·ªáu)";
      $("phaResult").innerHTML = "PHA: STOP<br/>Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â• 3 ng√†y s·∫°ch).<br/>Confidence‚âà25%";
    }

  }catch(err){
    $("kLock").textContent = "STOP";
    setDot(st.safe,"bad");
    logGate("ERROR: " + (err && err.message ? err.message : String(err)));
  }
};

/* ---------- Buttons ---------- */
$("btnReset").onclick = ()=>{
  if(confirm("RESET S·∫†CH: x√≥a ·∫£nh + x√≥a d·ªØ li·ªáu ƒë√£ l∆∞u?")){
    clearAll();
  }
};
$("btnPaste").onclick = ()=>{
  // Demo chain only (no OCR)
  const sd = isISODate($("startDate").value.trim()) ? $("startDate").value.trim() : todayISO();
  $("startDate").value = sd;
  const demo = [
    {db2:"81", g7:["75","42","09","81"], g6:["586","074","150"]},
    {db2:"55", g7:["45","43","00","57"], g6:["396","332","669"]},
    {db2:"37", g7:["95","36","37","42"], g6:["344","904","115"]},
  ].map((x,idx)=>({date:addDaysISO(sd, idx), ...x, meta:{name:"DEMO", preset:"-"}}));

  saveChain(demo);
  $("kSave").textContent = demo.length + " ng√†y";
  $("kLock").textContent = "ON";
  $("chainPreview").textContent = demo.map(x=>`${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n");
  const pha = phaSafe(demo);
  $("phaResult").innerHTML = `PHA: ${pha.pha}<br/>${pha.note}<br/>Confidence‚âà${pha.conf}%`;
  setDot(st.pre,"ok"); setDot(st.ocr,"warn"); setDot(st.gate,"ok"); setDot(st.safe,"ok");
  logGate("DEMO: OK (kh√¥ng ch·∫°y OCR).");
};

/* Init */
(function init(){
  drawEmpty();
  const saved = loadSaved();
  if(saved.length){
    $("kSave").textContent = saved.length + " ng√†y";
    $("kLock").textContent = "ON";
    $("chainPreview").textContent = saved.slice(-8).map(x=>`${x.date} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n");
    const pha = phaSafe(saved);
    $("phaResult").innerHTML = `PHA: ${pha.pha}<br/>${pha.note}<br/>Confidence‚âà${pha.conf}%`;
    setDot(st.safe, saved.length>=3 ? "ok" : "warn");
  }else{
    $("kSave").textContent = "empty";
  }
})();
</script>
</body>
</html>
