<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>B√πi H√†o ‚Äî Lotto ULTRA MASTER (ULTRA v3 ‚Ä¢ 2-ZONE OCR ‚Ä¢ PHA SAFE HardLock ‚Ä¢ HIT@3>=2)</title>
  <meta name="theme-color" content="#0b1220" />
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f1a2f;
      --card2:#0c172a;
      --line:rgba(255,255,255,.08);
      --txt:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.62);
      --muted2:rgba(255,255,255,.42);
      --ok:#2de38a;
      --warn:#ffcc66;
      --bad:#ff5a7a;
      --btn:#1f6fff;
      --btn2:#1a2d52;
      --shadow:0 12px 34px rgba(0,0,0,.45);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--txt);
      background: radial-gradient(1200px 800px at 20% 0%, #172b54 0%, rgba(23,43,84,0) 50%),
                  radial-gradient(900px 700px at 90% 10%, #123a3a 0%, rgba(18,58,58,0) 55%),
                  var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 40px}
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:22px;
      padding:16px 16px 14px;
      box-shadow:var(--shadow);
    }
    .title{font-weight:900;letter-spacing:.2px;font-size:22px;line-height:1.15}
    .sub{margin-top:8px;color:var(--muted);line-height:1.35}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .chip{
      display:inline-flex;gap:8px;align-items:center;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      padding:8px 10px;border-radius:999px;color:var(--muted);
      font-size:12.5px;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--muted2);box-shadow:0 0 0 3px rgba(255,255,255,.03) inset}
    .dot.ok{background:var(--ok)}
    .dot.warn{background:var(--warn)}
    .dot.bad{background:var(--bad)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px;margin-top:12px}
    @media (max-width: 900px){.grid{grid-template-columns:1fr}}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--r);
      padding:14px;
      box-shadow:0 10px 28px rgba(0,0,0,.35);
    }
    .card h3{margin:0;font-size:14px;letter-spacing:.2px}
    .hint{color:var(--muted);font-size:12.8px;line-height:1.35;margin-top:6px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:0;cursor:pointer;
      border-radius:14px;
      padding:11px 14px;
      color:white;
      background: linear-gradient(180deg, rgba(31,111,255,.95), rgba(31,111,255,.65));
      box-shadow:0 10px 24px rgba(31,111,255,.25);
      font-weight:800;
      letter-spacing:.2px;
      display:inline-flex;align-items:center;gap:10px;
    }
    .btn.secondary{
      background: linear-gradient(180deg, rgba(26,45,82,.95), rgba(26,45,82,.65));
      box-shadow:none;
      border:1px solid var(--line);
      color:rgba(255,255,255,.9);
      font-weight:800;
    }
    .btn.danger{
      background: linear-gradient(180deg, rgba(255,90,122,.92), rgba(255,90,122,.55));
      box-shadow:0 10px 24px rgba(255,90,122,.18);
    }
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input, textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background: rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:76px;resize:vertical;font-family:var(--mono);font-size:12.8px;line-height:1.35}
    .kpiGrid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .kpi{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
    }
    .kpi .big{font-size:26px;font-weight:900}
    .kpi .lab{color:var(--muted);font-size:12px;margin-top:2px}
    .monoBox{
      font-family:var(--mono);
      font-size:12.6px;
      white-space:pre-wrap;
      background: rgba(0,0,0,.20);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      color:rgba(255,255,255,.86);
      line-height:1.35;
    }
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      padding:8px 10px;border-radius:999px;color:var(--muted);
      font-size:12px;margin-right:8px;margin-bottom:8px
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      padding:9px 12px;border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      color:var(--muted);
      font-size:12.5px;
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .tab.active{background: rgba(31,111,255,.18);color:rgba(255,255,255,.9);border-color:rgba(31,111,255,.35)}
    .previewWrap{
      border:1px dashed rgba(255,255,255,.20);
      border-radius:16px;
      padding:10px;
      background: rgba(0,0,0,.12);
      overflow:hidden;
    }
    canvas{max-width:100%;height:auto;border-radius:12px;background:#fff}
    .small{font-size:12px;color:var(--muted)}
    .footer{margin-top:14px;color:var(--muted2);font-size:12px;line-height:1.35}
  </style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="title">B√πi H√†o ‚Äî Lotto ULTRA MASTER (ULTRA v3 ‚Ä¢ 2-ZONE OCR ‚Ä¢ PHA SAFE HardLock ‚Ä¢ HIT@3>=2)</div>
    <div class="sub">
      Lu·ªìng cao nh·∫•t: <b>StartDate Hard-Assign</b> ‚Üí <b>Preprocess</b> (trim/contrast/scale) ‚Üí <b>OCR 2-ZONE</b> (DB ri√™ng / BOTTOM ri√™ng)
      ‚Üí <b>Gate DB/G7/G6</b> ‚Üí <b>HardLock chu·ªói ng√†y</b> ‚Üí m·ªü <b>PHA SAFE</b> ‚Üí <b>SOI & CH·ªêT H∆Ø·ªöNG</b>.
      Thi·∫øu/kh√¥ng ch·∫Øc ‚Üí <b>STOP</b>.
    </div>
    <div class="chips">
      <div class="chip"><span class="dot ok" id="st_pre"></span> Preprocess</div>
      <div class="chip"><span class="dot" id="st_ocr"></span> OCR (2-zone)</div>
      <div class="chip"><span class="dot" id="st_gate"></span> Gate</div>
      <div class="chip"><span class="dot" id="st_pha"></span> PHA SAFE</div>
      <div class="chip"><span class="dot ok" id="st_hard"></span> HardLock=ON</div>
      <div class="chip"><span class="dot ok"></span> V3=2-ZONE + Rescue</div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h3>1) Nh·∫≠p ·∫£nh</h3>
      <div class="hint">M·∫πo ·∫£nh: crop s√°t ph·∫ßn b·∫£ng (t·ª´ ‚ÄúƒêB/DB‚Äù t·ªõi ‚Äú7‚Äù). Tr√°nh d√≠nh footer tab & header qu·∫£ng c√°o. N·∫øu ·∫£nh ‚Äúd√≠nh‚Äù ‚Üí b·∫≠t Rescue presets.</div>
      <div class="hr"></div>
      <div class="row">
        <input id="file" type="file" accept="image/*" multiple />
        <button class="btn secondary" id="btnPaste">üìã D√°n m·∫´u</button>
        <button class="btn danger" id="btnReset">üßΩ RESET S·∫†CH</button>
        <button class="btn" id="btnFull">‚ö° CH·∫†Y FULL</button>
      </div>

      <div class="hr"></div>

      <div class="kpiGrid">
        <div class="kpi">
          <div class="big" id="k_ok">0</div>
          <div class="lab">Batch OK</div>
        </div>
        <div class="kpi">
          <div class="big" id="k_fail">0</div>
          <div class="lab">Batch FAIL</div>
        </div>
        <div class="kpi">
          <div class="big" id="k_days">0</div>
          <div class="lab">Save (ng√†y)</div>
        </div>
        <div class="kpi">
          <div class="big" id="k_conf">--</div>
          <div class="lab">PHA Confidence</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row" style="gap:12px;align-items:flex-start">
        <div style="flex:1;min-width:260px">
          <div class="small"><b>StartDate</b> (b·∫Øt bu·ªôc ‚Äî YYYY-MM-DD)</div>
          <input id="startDate" placeholder="2026-02-28" />
          <div class="footer">C·ª©ng nh·∫•t: <b>ng√†y = StartDate + index ·∫£nh</b>. OCR header ch·ªâ ƒë·ªÉ x√°c nh·∫≠n (kh√¥ng quy·∫øt ƒë·ªãnh).</div>
        </div>
        <div style="flex:1;min-width:260px">
          <div class="small"><b>Manual Fix (DB|G7|G6)</b> ‚Äî d√°n khi OCR l·ªách</div>
          <input id="manualFix" placeholder="VD: DB=83 | G7=57 42 39 13 | G6=247 554 108" />
          <div class="footer">Ch·ªâ d√πng khi Gate fail. Kh√¥ng ‚Äúƒëo√°n d·ªØ li·ªáu‚Äù.</div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn secondary" id="btnRescue">üõü Rescue presets (t·ª± ch·∫°y 4 m·ª©c trim)</button>
        <span class="pill">Gate-1: DB2 + G7(4) + G6(3)</span>
        <span class="pill">Gate-2: DB5 ‚Üí DB2 kh·ªõp</span>
        <span class="pill">Gate-3: l·ªách ng√†y = STOP</span>
      </div>

      <div class="hr"></div>

      <div class="tabs">
        <div class="tab active" data-tab="all">Preview t·ªïng (auto-trim)</div>
        <div class="tab" data-tab="db">DB-zone</div>
        <div class="tab" data-tab="bot">BOTTOM-zone</div>
      </div>
      <div class="previewWrap" style="margin-top:10px">
        <canvas id="cvAll" width="900" height="1200"></canvas>
        <div style="display:none">
          <canvas id="cvDB" width="900" height="1200"></canvas>
          <canvas id="cvBot" width="900" height="1200"></canvas>
        </div>
      </div>
      <div class="footer">ULTRA v3: c·∫Øt 2 v√πng ri√™ng ƒë·ªÉ gi·∫£m nhi·ªÖu OCR: (1) v√πng ƒêB/DB (2) v√πng cu·ªëi ch·ª©a G6/G7.</div>
    </div>

    <div class="card">
      <h3>2) OCR ‚Üí Gate ‚Üí PHA SAFE ‚Üí Ch·ªët</h3>
      <div class="hint">Nguy√™n t·∫Øc: <b>OCR s·∫°ch</b> ‚Üí <b>Gate ƒë√∫ng</b> ‚Üí m·ªõi m·ªü PHA. Thi·∫øu/kh√¥ng ch·∫Øc ‚Üí STOP.</div>

      <div class="hr"></div>

      <div class="small"><b>OCR Raw ‚Äî DB zone</b></div>
      <div class="monoBox" id="rawDB">(tr·ªëng)</div>

      <div class="hr"></div>

      <div class="small"><b>OCR Raw ‚Äî BOTTOM zone</b></div>
      <div class="monoBox" id="rawBot">(tr·ªëng)</div>

      <div class="hr"></div>

      <div class="small"><b>Gate Output</b></div>
      <div class="monoBox" id="gateOut">GATE: waiting</div>

      <div class="hr"></div>

      <div class="small"><b>PHA SAFE ‚Ä¢ HardLock</b> (ch·ªâ m·ªü pha khi ‚â• 3 ng√†y s·∫°ch)</div>
      <div class="monoBox" id="phaOut">PHA: STOP (ch∆∞a ƒë·ªß d·ªØ li·ªáu s·∫°ch)</div>

      <div class="hr"></div>

      <div class="small"><b>SOI & CH·ªêT H∆Ø·ªöNG (6 d√≤ng)</b> ‚Äî ch·ªët tr∆∞·ªõc, gi·∫£i th√≠ch sau</div>
      <div class="monoBox" id="chotOut">(ch∆∞a ch·ªët)</div>
      <div class="row" style="margin-top:10px">
        <button class="btn secondary" id="btnAnalyze">üìå PH√ÇN T√çCH & CH·ªêT</button>
        <button class="btn secondary" id="btnExport">‚¨áÔ∏è Export JSON</button>
        <button class="btn secondary" id="btnImport">‚¨ÜÔ∏è Import JSON</button>
      </div>

      <div class="footer">
        Checklist ch·ªëng l·ªách:
        <ul style="margin:8px 0 0 18px;padding:0;color:var(--muted)">
          <li>Ng√†y ph·∫£i tƒÉng ƒë√∫ng th·ª© t·ª± (Hard-Assign theo StartDate + index).</li>
          <li>M·ªói ng√†y ph·∫£i c√≥ DB2 + G7(4) + G6(3).</li>
          <li>Gate fail ‚Üí Manual Fix / ƒë·ªïi ·∫£nh / b·∫≠t Rescue.</li>
          <li>Kh√¥ng ƒë·ªß s·∫°ch ‚Üí STOP, kh√¥ng soi pha.</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<!-- Tesseract -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<!-- OpenCV -->
<script async src="https://docs.opencv.org/4.x/opencv.js"></script>

<script>
/* ===========================
   ULTRA v3 ‚Äî Core
=========================== */
const $ = (id)=>document.getElementById(id);
const LS_KEY = "BH_ULTRA_V3_CHAIN";
const LS_META = "BH_ULTRA_V3_META";

const state = {
  images: [],
  ok:0, fail:0,
  lastPreview: null,
  lastZones: {db:null, bot:null},
  lastOCR: {db:"", bot:""},
  lastGate: null,
  chain: []
};

const UI = {
  pre: $("st_pre"),
  ocr: $("st_ocr"),
  gate: $("st_gate"),
  pha: $("st_pha"),
  k_ok: $("k_ok"),
  k_fail: $("k_fail"),
  k_days: $("k_days"),
  k_conf: $("k_conf"),
  rawDB: $("rawDB"),
  rawBot: $("rawBot"),
  gateOut: $("gateOut"),
  phaOut: $("phaOut"),
  chotOut: $("chotOut"),
};

function setDot(dot, kind){
  dot.classList.remove("ok","warn","bad");
  if(kind) dot.classList.add(kind);
}
function setStatus(step, kind){
  if(step==="ocr") setDot(UI.ocr, kind);
  if(step==="gate") setDot(UI.gate, kind);
  if(step==="pha") setDot(UI.pha, kind);
}

function toast(text){
  UI.gateOut.textContent = text;
}

/* ===========================
   Storage
=========================== */
function loadChain(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    state.chain = raw ? JSON.parse(raw) : [];
  }catch(e){ state.chain=[]; }
  UI.k_days.textContent = String(state.chain.length);
}
function saveChain(){
  localStorage.setItem(LS_KEY, JSON.stringify(state.chain));
  UI.k_days.textContent = String(state.chain.length);
}
function resetAll(){
  state.images=[]; state.ok=0; state.fail=0;
  state.lastPreview=null; state.lastZones={db:null,bot:null};
  state.lastOCR={db:"",bot:""}; state.lastGate=null;
  state.chain=[];
  saveChain();
  UI.k_ok.textContent="0"; UI.k_fail.textContent="0"; UI.k_conf.textContent="--";
  UI.rawDB.textContent="(tr·ªëng)"; UI.rawBot.textContent="(tr·ªëng)";
  UI.gateOut.textContent="GATE: waiting";
  UI.phaOut.textContent="PHA: STOP (ch∆∞a ƒë·ªß d·ªØ li·ªáu s·∫°ch)";
  UI.chotOut.textContent="(ch∆∞a ch·ªët)";
  setStatus("ocr", null); setStatus("gate", null); setStatus("pha", null);
}

/* ===========================
   Date utils
=========================== */
function parseDateYYYYMMDD(s){
  const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec((s||"").trim());
  if(!m) return null;
  const d = new Date(Date.UTC(+m[1], +m[2]-1, +m[3]));
  if(isNaN(d.getTime())) return null;
  return d;
}
function fmtDate(d){
  const y=d.getUTCFullYear();
  const m=String(d.getUTCMonth()+1).padStart(2,"0");
  const day=String(d.getUTCDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function addDaysUTC(d, n){
  const x = new Date(d.getTime());
  x.setUTCDate(x.getUTCDate()+n);
  return x;
}

/* ===========================
   Canvas preprocess (no OpenCV dependency)
   - auto trim (rough)
   - contrast + scale
=========================== */
function drawImageToCanvas(img, canvas, scale=1){
  const ctx = canvas.getContext("2d");
  const w = Math.floor(img.naturalWidth*scale);
  const h = Math.floor(img.naturalHeight*scale);
  canvas.width = w; canvas.height = h;
  ctx.drawImage(img, 0, 0, w, h);
}
function enhanceContrast(canvas){
  const ctx = canvas.getContext("2d");
  const {width:w,height:h} = canvas;
  const img = ctx.getImageData(0,0,w,h);
  const d = img.data;
  // grayscale + mild contrast
  const contrast = 1.25;
  const bias = -18;
  for(let i=0;i<d.length;i+=4){
    const r=d[i], g=d[i+1], b=d[i+2];
    let y = (0.299*r + 0.587*g + 0.114*b);
    y = (y-128)*contrast + 128 + bias;
    y = Math.max(0, Math.min(255, y));
    d[i]=d[i+1]=d[i+2]=y;
    d[i+3]=255;
  }
  ctx.putImageData(img,0,0);
}
function cropCanvas(src, rect){
  const out = document.createElement("canvas");
  out.width = Math.max(1, Math.floor(rect.w));
  out.height = Math.max(1, Math.floor(rect.h));
  const octx = out.getContext("2d");
  octx.drawImage(src, rect.x, rect.y, rect.w, rect.h, 0, 0, out.width, out.height);
  return out;
}

/* ULTRA v3: Auto-trim rough heuristic
   - user already crops near table; we just trim top/bottom by ratios to remove header/footer.
*/
function autoTrimRect(canvas, topRatio=0.12, botRatio=0.14, leftRatio=0.03, rightRatio=0.03){
  const w=canvas.width, h=canvas.height;
  const x = Math.floor(w*leftRatio);
  const y = Math.floor(h*topRatio);
  const ww = Math.floor(w*(1-leftRatio-rightRatio));
  const hh = Math.floor(h*(1-topRatio-botRatio));
  return {x,y,w:ww,h:hh};
}

/* 2-ZONE split:
   - DB zone: upper section where ƒêB + DB number lives
   - BOTTOM zone: lower section containing G6/G7 lines
   These ratios are tuned for common app screenshots.
*/
function zoneRects(trimmed){
  const w = trimmed.width, h=trimmed.height;
  const db = {x:0, y:Math.floor(h*0.06), w:w, h:Math.floor(h*0.30)};     // includes DB + G1 rows
  const bot = {x:0, y:Math.floor(h*0.62), w:w, h:Math.floor(h*0.38)};   // includes G6/G7 area + bottom
  return {db, bot};
}

/* Rescue presets: try multiple trims */
const RESCUE_PRESETS = [
  {top:0.10, bot:0.12},
  {top:0.12, bot:0.14},
  {top:0.14, bot:0.16},
  {top:0.16, bot:0.18},
];

/* ===========================
   OCR (Tesseract)
=========================== */
async function ocrCanvas(canvas){
  // Use eng+vie (vie might not exist in CDN build; fallback to eng)
  try{
    const { data } = await Tesseract.recognize(canvas, "eng", {
      tessedit_char_whitelist: "0123456789DBƒêBVGVEVLVMVDVH:|=-. \n",
    });
    return data.text || "";
  }catch(e){
    const { data } = await Tesseract.recognize(canvas, "eng", {});
    return data.text || "";
  }
}

/* ===========================
   Gate parsing
   Goal: extract DB2, G7(4), G6(3)
   - DB2 from 5-digit special prize (last 2 digits) OR direct "DB=xx"
   - G7: four 2-digit numbers (line contains 4 groups of 2)
   - G6: three 3-digit numbers (line contains 3 groups of 3)
=========================== */
function cleanText(t){
  return (t||"")
    .replace(/[^\dDBƒêBVGVEVLVMVDVH|=:\n ]/g," ")
    .replace(/\s+/g," ")
    .replace(/ \n/g,"\n")
    .trim();
}
function findAllNums(text, len){
  const re = new RegExp(`\\b\\d{${len}}\\b`,"g");
  return (text.match(re) || []);
}
function parseManualFix(s){
  const t=(s||"").trim();
  if(!t) return null;
  const dbm = /DB\s*=\s*(\d{2})/i.exec(t);
  const g7m = /G7\s*=\s*([0-9 ]+)/i.exec(t);
  const g6m = /G6\s*=\s*([0-9 ]+)/i.exec(t);
  const out = {};
  if(dbm) out.db2 = dbm[1];
  if(g7m){
    const arr = (g7m[1].match(/\b\d{2}\b/g)||[]).slice(0,4);
    if(arr.length===4) out.g7 = arr;
  }
  if(g6m){
    const arr = (g6m[1].match(/\b\d{3}\b/g)||[]).slice(0,3);
    if(arr.length===3) out.g6 = arr;
  }
  return (out.db2 && out.g7 && out.g6) ? out : null;
}
function gateFromOCR(rawDB, rawBot, manualFixStr){
  const manual = parseManualFix(manualFixStr);
  if(manual){
    return {ok:true, via:"MANUAL", ...manual, errs:[]};
  }

  const dbT = cleanText(rawDB);
  const botT = cleanText(rawBot);

  // DB5 from db zone: look for 5-digit number likely DB prize
  const nums5 = findAllNums(dbT, 5);
  // heuristic: DB prize is often the biggest in DB zone; OCR tends to capture it
  // take first 5-digit if exists
  let db5 = nums5.length ? nums5[0] : null;
  let db2 = db5 ? db5.slice(-2) : null;

  // From bottom zone, get candidates
  const nums2 = findAllNums(botT, 2);
  const nums3 = findAllNums(botT, 3);

  // find a line with 4 two-digit numbers for G7
  // if OCR collapsed spaces, fallback: take last 4 of nums2
  let g7 = null;
  // try line-based first
  const lines = botT.split("\n").map(x=>x.trim()).filter(Boolean);
  for(const ln of lines){
    const a = (ln.match(/\b\d{2}\b/g)||[]);
    if(a.length>=4){
      g7 = a.slice(0,4);
      break;
    }
  }
  if(!g7 && nums2.length>=4){
    g7 = nums2.slice(-4);
  }

  // G6: line with 3 three-digit numbers
  let g6 = null;
  for(const ln of lines){
    const a = (ln.match(/\b\d{3}\b/g)||[]);
    if(a.length>=3){
      g6 = a.slice(0,3);
      break;
    }
  }
  if(!g6 && nums3.length>=3){
    g6 = nums3.slice(0,3);
  }

  const errs=[];
  if(!db2) errs.push("MISS_DB");
  if(!g7 || g7.length!==4) errs.push("MISS_G7");
  if(!g6 || g6.length!==3) errs.push("MISS_G6");

  return { ok: errs.length===0, via:"OCR", db2, g7, g6, errs, db5 };
}

/* ===========================
   PHA SAFE (High safety)
   - only if >=3 days clean
   - HardLock day order (startDate + idx)
   - STOP if inconsistent or noisy
=========================== */
function sum2(db2){
  return (parseInt(db2[0],10)+parseInt(db2[1],10))%10;
}
function phaSafe(chain){
  if(chain.length < 3){
    return {ok:false, pha:"STOP", conf:25, note:"Thi·∫øu d·ªØ li·ªáu (c·∫ßn ‚â•3 ng√†y s·∫°ch)."};
  }
  const last3 = chain.slice(-3);
  const dbs = last3.map(x=>x.db2);
  const sums = dbs.map(sum2);

  let score = 0;
  const notes = [];

  // Rule: G7 d√≠nh l√µi + G6 c√≤n neo = c√≤n nh·ªãp | Bung bi√™n = c·∫£nh b√°o
  const last = chain[chain.length-1];
  const g7HasDB = last.g7.includes(last.db2);
  if(g7HasDB){ score += 2; notes.push("G7 d√≠nh l√µi"); }

  // "G6 c√≤n neo": any G6 ends with DB tail or shares digit
  const g6HasTail = last.g6.some(x=>x.slice(-2)===last.db2);
  if(g6HasTail){ score += 1; notes.push("G6 c√≤n neo"); }

  // DB repeats within last3 (l√µi)
  if(new Set(dbs).size <= 2){ score += 1; notes.push("ƒêB c√≥ l√µi l·∫∑p"); }

  // T·ªïng ·ªïn ƒë·ªãnh
  if(new Set(sums).size <= 2){ score += 1; notes.push("T·ªïng ·ªïn ƒë·ªãnh"); }

  // Bung bi√™n (0/9 head)
  if(last.db2[0]==="0" || last.db2[0]==="9"){ score -= 2; notes.push("Bung bi√™n (ƒë·∫ßu 0/9)"); }

  // Too many distinct sums indicates noise
  if(new Set(sums).size === 3){ score -= 1; notes.push("T·ªïng nhi·ªÖu (3 t·ªïng)"); }

  let pha = "ƒê·∫¢O";
  if(score >= 3) pha = "CH·∫†Y";
  if(score <= 0) pha = "X·∫¢";

  let conf = 55 + score*7;
  conf = Math.max(35, Math.min(78, conf));

  // Hard STOP conditions
  // If last day is bi√™n AND no g7 d√≠nh l√µi => STOP
  if((last.db2[0]==="0" || last.db2[0]==="9") && !g7HasDB){
    return {ok:false, pha:"STOP", conf:38, note:"Bi√™n + kh√¥ng c√≥ l√µi g7 ‚Üí d·ªÖ b·∫´y. STOP.", notes};
  }

  return {ok:true, pha, conf, note:"Chu·ªói s·∫°ch. ƒê·ªß ƒëi·ªÅu ki·ªán m·ªü PHA SAFE.", notes};
}

/* ===========================
   SOI & CH·ªêT (HIT@3>=2)
   - 3 tr∆∞·ªùng h·ª£p (TH1/TH2/TH3)
   - 1 c·∫∑p ch·ªët (∆∞u ti√™n)
   - 1 anti-b·∫´y (1 con)
=========================== */
function pad2(n){ return String(n).padStart(2,"0"); }
function rotate(db2, k){
  let x = (parseInt(db2,10)+k)%100;
  return pad2(x);
}
function pickChot(chain, pha){
  const last = chain[chain.length-1];
  const db = last.db2;

  // ∆∞u ti√™n l√µi = (ƒëu√¥i ƒêB + l√µi G7)
  const g7 = last.g7.slice();
  // ‚Äúl√µi g7‚Äù: ∆∞u ti√™n s·ªë tr√πng digit v·ªõi db
  const core = g7.find(x=>x[1]===db[1] || x[0]===db[0]) || g7[0];

  if(pha==="CH·∫†Y"){
    // ch·ªët b√°m l√µi: ∆∞u ti√™n db n·∫øu g7 d√≠nh l√µi, else core
    return last.g7.includes(db) ? db : core;
  }
  if(pha==="ƒê·∫¢O"){
    // ƒë·∫£o nh·∫π quanh l√µi
    return rotate(core, 1);
  }
  if(pha==="X·∫¢"){
    // x·∫£: nh·∫£y +5 ƒë·ªÉ tr√°nh d√≠nh l·∫°i
    return rotate(db, 5);
  }
  return core;
}
function pickAnti(chain){
  const last = chain[chain.length-1];
  // anti b·∫´y: +7 (kh√°c nh·ªãp), ho·∫∑c l·∫•y 1 con ‚Äúl·ªách‚Äù kh√¥ng n·∫±m trong g7
  let anti = rotate(last.db2, 7);
  if(last.g7.includes(anti)) anti = rotate(last.db2, 9);
  return anti;
}
function directionText(pha){
  if(pha==="CH·∫†Y") return "B√°m l√µi (ƒëu√¥i ƒêB + l√µi G7), tr√°nh √©p bi√™n";
  if(pha==="ƒê·∫¢O") return "ƒê·∫£o/k·ªÅ quanh l√µi (nh·∫π), kh√¥ng ƒë·∫©y l·ª±c";
  if(pha==="X·∫¢") return "Gi·∫£m l·ª±c, n√© bi√™n, ∆∞u ti√™n anti";
  return "STOP";
}
function roleText(chain){
  const last = chain[chain.length-1];
  const parts=[];
  if(last.g7.includes(last.db2)) parts.push("G7 d√≠nh l√µi");
  const g6Neo = last.g6.some(x=>x.slice(-2)===last.db2);
  if(g6Neo) parts.push("G6 c√≤n neo");
  if(!parts.length) parts.push("G6/G7 kh√¥ng l·ªô r√µ");
  return parts.join(" + ");
}
function buildCases(chain, pha){
  const last = chain[chain.length-1];
  const db = last.db2;
  const core = pickChot(chain, "CH·∫†Y");
  const a = pickChot(chain, pha);

  // 3 TH r√µ r√†ng
  const th1 = (pha==="CH·∫†Y") ? `TH1: Gi·ªØ nh·ªãp (b√°m l√µi) ‚Üí ${a}` : `TH1: H·ªìi l√µi ‚Üí ${core}`;
  const th2 = `TH2: ƒê·∫£o 1 nh·ªãp quanh l√µi ‚Üí ${rotate(a,1)} / ${rotate(a, -1)}`;
  const th3 = `TH3: Bung/ƒë√°nh l·∫°c ‚Üí ∆∞u ti√™n anti ${pickAnti(chain)}`;
  return [th1, th2, th3];
}
function render6Lines(chain){
  const ps = phaSafe(chain);
  UI.k_conf.textContent = ps.conf ? `${ps.conf}%` : "--";
  if(!ps.ok){
    return `1) PHA ng√†y: STOP
2) H∆∞·ªõng ch√≠nh: D·ª™NG (thi·∫øu ch·∫Øc)
3) Vai tr√≤ G6‚ÄìG7: ${ps.notes?.join(", ") || ps.note}
4) Quy·∫øt ƒë·ªãnh: D·ª™NG
5) Ch·ªët 1 c·∫∑p: --
6) Anti-b·∫´y: -- | Tin c·∫≠y‚âà${ps.conf||35}%`;
  }

  const chot = pickChot(chain, ps.pha);
  const anti = pickAnti(chain);
  const th = buildCases(chain, ps.pha);

  const play = (ps.pha==="X·∫¢") ? "CH∆†I NH·∫∏/HO·∫∂C D·ª™NG" : "CH∆†I";

  return `1) PHA ng√†y: ${ps.pha}
2) H∆∞·ªõng ch√≠nh: ${directionText(ps.pha)}
3) Vai tr√≤ G6‚ÄìG7: ${roleText(chain)}
4) TH c·ª• th·ªÉ: ${th[0]} | ${th[1]} | ${th[2]}
5) Ch·ªët 1 c·∫∑p: ${chot}
6) Anti-b·∫´y: ${anti} | Quy·∫øt ƒë·ªãnh: ${play} | Tin c·∫≠y‚âà${ps.conf}%`;
}

/* ===========================
   Pipeline: one image -> preprocess -> 2-zone -> OCR -> gate -> save
=========================== */
function setTab(which){
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.tab===which);
  });
  $("cvAll").style.display = (which==="all") ? "block" : "none";
  $("cvDB").style.display  = (which==="db") ? "block" : "none";
  $("cvBot").style.display = (which==="bot") ? "block" : "none";
}
document.querySelectorAll(".tab").forEach(t=>{
  t.addEventListener("click", ()=>setTab(t.dataset.tab));
});

async function waitOpenCVReady(timeoutMs=8000){
  if(window.cv && cv.Mat) return true;
  const t0=Date.now();
  while(Date.now()-t0<timeoutMs){
    await new Promise(r=>setTimeout(r,120));
    if(window.cv && cv.Mat) return true;
  }
  return false;
}

async function processImageFile(file, idx, preset=null){
  setStatus("ocr","warn");
  setStatus("gate",null);
  setStatus("pha",null);

  const start = parseDateYYYYMMDD($("startDate").value);
  if(!start) throw new Error("MISS_STARTDATE");

  const img = new Image();
  img.crossOrigin="anonymous";
  const url = URL.createObjectURL(file);
  await new Promise((res,rej)=>{
    img.onload=()=>res();
    img.onerror=()=>rej(new Error("IMG_LOAD_FAIL"));
    img.src=url;
  });

  // draw + enhance
  const cvAll = $("cvAll");
  drawImageToCanvas(img, cvAll, 1.0);
  enhanceContrast(cvAll);

  // trim preset
  const top = preset ? preset.top : 0.12;
  const bot = preset ? preset.bot : 0.14;
  const rectTrim = autoTrimRect(cvAll, top, bot, 0.03, 0.03);
  const trimmed = cropCanvas(cvAll, rectTrim);

  // zones
  const z = zoneRects(trimmed);
  const cvDB = $("cvDB");
  const cvBot = $("cvBot");

  // Render preview canvases
  cvAll.width = trimmed.width; cvAll.height = trimmed.height;
  cvAll.getContext("2d").drawImage(trimmed,0,0);
  const dbC = cropCanvas(trimmed, z.db);
  const botC = cropCanvas(trimmed, z.bot);

  cvDB.width=dbC.width; cvDB.height=dbC.height;
  cvDB.getContext("2d").drawImage(dbC,0,0);

  cvBot.width=botC.width; cvBot.height=botC.height;
  cvBot.getContext("2d").drawImage(botC,0,0);

  // OCR
  UI.rawDB.textContent="(OCR...)";
  UI.rawBot.textContent="(OCR...)";
  const rawDB = await ocrCanvas(dbC);
  const rawBot = await ocrCanvas(botC);

  state.lastOCR.db = rawDB;
  state.lastOCR.bot = rawBot;
  UI.rawDB.textContent = rawDB.trim() ? rawDB : "(r·ªóng)";
  UI.rawBot.textContent = rawBot.trim() ? rawBot : "(r·ªóng)";
  setStatus("ocr","ok");

  // Gate
  setStatus("gate","warn");
  const gate = gateFromOCR(rawDB, rawBot, $("manualFix").value);
  state.lastGate = gate;

  const day = fmtDate(addDaysUTC(start, idx));
  const outLines = [];
  outLines.push(`GATE: ${gate.ok ? "OK" : "FAIL"} (via=${gate.via})`);
  if(!gate.ok) outLines.push(`errs=${gate.errs.join(",")}`);
  outLines.push(`day=${day}`);
  outLines.push(`DB=${gate.db2||"--"} | G7=${gate.g7?gate.g7.join(" "):"--"} | G6=${gate.g6?gate.g6.join(" "):"--"}`);
  UI.gateOut.textContent = outLines.join("\n");

  if(!gate.ok){
    setStatus("gate","bad");
    throw new Error("GATE_FAIL");
  }
  setStatus("gate","ok");

  // Save day record
  const rec = { day, db2: gate.db2, g7: gate.g7, g6: gate.g6, meta:{via:gate.via} };
  return rec;
}

function hardLockAndMerge(records){
  // HardLock: unique by day, sorted by day asc
  const map = new Map();
  for(const r of state.chain) map.set(r.day, r);
  for(const r of records) map.set(r.day, r);

  const arr = Array.from(map.values()).sort((a,b)=>a.day.localeCompare(b.day));

  // Gate-3: no day jump backwards is already prevented by sort + HardAssign;
  // but we enforce continuity for the newly added block if needed.
  state.chain = arr;
  saveChain();

  // PHA SAFE output
  const ps = phaSafe(state.chain);
  const block = [];
  block.push(`Chu·ªói ƒë√£ l∆∞u (theo ng√†y): ${state.chain.length} ng√†y`);
  block.push(state.chain.slice(-7).map(x=>`${x.day} | DB=${x.db2} | G7=${x.g7.join(" ")} | G6=${x.g6.join(" ")}`).join("\n"));
  block.push("\n---");
  block.push(`PHA: ${ps.ok ? ps.pha : "STOP"}`);
  block.push(ps.note);
  if(ps.notes && ps.notes.length) block.push(`Notes: ${ps.notes.join(", ")}`);
  block.push(`Confidence‚âà${ps.conf}%`);
  UI.phaOut.textContent = block.join("\n");
  setStatus("pha", ps.ok ? "ok" : "bad");
  UI.k_conf.textContent = `${ps.conf}%`;
}

/* ===========================
   Batch run
=========================== */
async function runBatch(files, useRescue=false){
  const start = parseDateYYYYMMDD($("startDate").value);
  if(!start){
    alert("B·∫°n ch∆∞a nh·∫≠p StartDate ƒë√∫ng format YYYY-MM-DD.");
    return;
  }
  UI.chotOut.textContent="(ch∆∞a ch·ªët)";
  setStatus("pha", null);

  state.ok=0; state.fail=0;
  UI.k_ok.textContent="0"; UI.k_fail.textContent="0";

  const recs = [];
  for(let i=0;i<files.length;i++){
    try{
      let rec=null;
      if(useRescue){
        let lastErr=null;
        for(const p of RESCUE_PRESETS){
          try{
            rec = await processImageFile(files[i], i, p);
            break;
          }catch(e){ lastErr=e; }
        }
        if(!rec) throw lastErr || new Error("RESCUE_FAIL");
      }else{
        rec = await processImageFile(files[i], i, null);
      }
      recs.push(rec);
      state.ok++; UI.k_ok.textContent=String(state.ok);
    }catch(e){
      state.fail++; UI.k_fail.textContent=String(state.fail);
      // keep going
    }
  }

  if(recs.length){
    hardLockAndMerge(recs);
  }else{
    UI.phaOut.textContent="PHA: STOP\nKh√¥ng c√≥ ng√†y s·∫°ch ƒë·ªÉ l∆∞u.";
    setStatus("pha","bad");
  }
}

/* ===========================
   Buttons
=========================== */
$("file").addEventListener("change", (e)=>{
  state.images = Array.from(e.target.files||[]);
});

$("btnFull").addEventListener("click", async ()=>{
  if(!state.images.length){
    alert("Ch∆∞a ch·ªçn ·∫£nh.");
    return;
  }
  setStatus("ocr","warn");
  await runBatch(state.images, false);
});

$("btnRescue").addEventListener("click", async ()=>{
  if(!state.images.length){
    alert("Ch∆∞a ch·ªçn ·∫£nh.");
    return;
  }
  setStatus("ocr","warn");
  await runBatch(state.images, true);
});

$("btnReset").addEventListener("click", ()=>{
  if(confirm("RESET S·∫†CH: x√≥a d·ªØ li·ªáu local + batch?")){
    localStorage.removeItem(LS_KEY);
    localStorage.removeItem(LS_META);
    resetAll();
  }
});

$("btnAnalyze").addEventListener("click", ()=>{
  loadChain();
  const out = render6Lines(state.chain);
  UI.chotOut.textContent = out;
});

$("btnExport").addEventListener("click", ()=>{
  loadChain();
  const blob = new Blob([JSON.stringify({v:"ULTRA_V3", chain: state.chain}, null, 2)], {type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="BH_ULTRA_V3_export.json";
  a.click();
});

$("btnImport").addEventListener("click", async ()=>{
  const inp=document.createElement("input");
  inp.type="file"; inp.accept="application/json";
  inp.onchange=async ()=>{
    const f=inp.files[0]; if(!f) return;
    const txt=await f.text();
    try{
      const obj=JSON.parse(txt);
      if(!obj.chain || !Array.isArray(obj.chain)) throw new Error("BAD_JSON");
      state.chain = obj.chain;
      saveChain();
      hardLockAndMerge([]);
      alert("Import OK.");
    }catch(e){
      alert("Import FAIL: file kh√¥ng h·ª£p l·ªá.");
    }
  };
  inp.click();
});

$("btnPaste").addEventListener("click", ()=>{
  // D√°n m·∫´u h∆∞·ªõng d·∫´n manual fix
  $("manualFix").value = "DB=83 | G7=57 42 39 13 | G6=247 554 108";
  $("startDate").value = $("startDate").value || "2026-02-28";
  alert("ƒê√£ d√°n m·∫´u Manual Fix. (Ch·ªâ d√πng khi Gate fail)");
});

/* ===========================
   Init
=========================== */
loadChain();
hardLockAndMerge([]); // refresh PHA box

// default startDate if empty: today (VN)
(function initDate(){
  if($("startDate").value.trim()) return;
  const now = new Date();
  const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
  $("startDate").value = fmtDate(d);
})();

</script>
</body>
</html>
